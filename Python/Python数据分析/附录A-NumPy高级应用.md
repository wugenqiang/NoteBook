åœ¨è¿™ç¯‡é™„å½•ä¸­ï¼Œæˆ‘ä¼šæ·±å…¥NumPyåº“çš„æ•°ç»„è®¡ç®—ã€‚è¿™ä¼šåŒ…æ‹¬ndarrayæ›´å†…éƒ¨çš„ç»†èŠ‚ï¼Œå’Œæ›´é«˜çº§çš„æ•°ç»„æ“ä½œå’Œç®—æ³•ã€‚

æœ¬ç« åŒ…æ‹¬äº†ä¸€äº›æ‚ä¹±çš„ç« èŠ‚ï¼Œä¸éœ€è¦ä»”ç»†ç ”ç©¶ã€‚

# A.1 ndarrayå¯¹è±¡çš„å†…éƒ¨æœºç†

NumPyçš„ndarrayæä¾›äº†ä¸€ç§å°†åŒè´¨æ•°æ®å—ï¼ˆå¯ä»¥æ˜¯è¿ç»­æˆ–è·¨è¶Šï¼‰è§£é‡Šä¸ºå¤šç»´æ•°ç»„å¯¹è±¡çš„æ–¹å¼ã€‚æ­£å¦‚ä½ ä¹‹å‰æ‰€çœ‹åˆ°çš„é‚£æ ·ï¼Œæ•°æ®ç±»å‹ï¼ˆdtypeï¼‰å†³å®šäº†æ•°æ®çš„è§£é‡Šæ–¹å¼ï¼Œæ¯”å¦‚æµ®ç‚¹æ•°ã€æ•´æ•°ã€å¸ƒå°”å€¼ç­‰ã€‚

ndarrayå¦‚æ­¤å¼ºå¤§çš„éƒ¨åˆ†åŸå› æ˜¯æ‰€æœ‰æ•°ç»„å¯¹è±¡éƒ½æ˜¯æ•°æ®å—çš„ä¸€ä¸ªè·¨åº¦è§†å›¾ï¼ˆstrided viewï¼‰ã€‚ä½ å¯èƒ½æƒ³çŸ¥é“æ•°ç»„è§†å›¾arr[::2,::-1]ä¸å¤åˆ¶ä»»ä½•æ•°æ®çš„åŸå› æ˜¯ä»€ä¹ˆã€‚ç®€å•åœ°è¯´ï¼Œndarrayä¸åªæ˜¯ä¸€å—å†…å­˜å’Œä¸€ä¸ªdtypeï¼Œå®ƒè¿˜æœ‰è·¨åº¦ä¿¡æ¯ï¼Œè¿™ä½¿å¾—æ•°ç»„èƒ½ä»¥å„ç§æ­¥å¹…ï¼ˆstep sizeï¼‰åœ¨å†…å­˜ä¸­ç§»åŠ¨ã€‚æ›´å‡†ç¡®åœ°è®²ï¼Œndarrayå†…éƒ¨ç”±ä»¥ä¸‹å†…å®¹ç»„æˆï¼š

- ä¸€ä¸ªæŒ‡å‘æ•°æ®ï¼ˆå†…å­˜æˆ–å†…å­˜æ˜ å°„æ–‡ä»¶ä¸­çš„ä¸€å—æ•°æ®ï¼‰çš„æŒ‡é’ˆã€‚
- æ•°æ®ç±»å‹æˆ–dtypeï¼Œæè¿°åœ¨æ•°ç»„ä¸­çš„å›ºå®šå¤§å°å€¼çš„æ ¼å­ã€‚
- ä¸€ä¸ªè¡¨ç¤ºæ•°ç»„å½¢çŠ¶ï¼ˆshapeï¼‰çš„å…ƒç»„ã€‚
- ä¸€ä¸ªè·¨åº¦å…ƒç»„ï¼ˆstrideï¼‰ï¼Œå…¶ä¸­çš„æ•´æ•°æŒ‡çš„æ˜¯ä¸ºäº†å‰è¿›åˆ°å½“å‰ç»´åº¦ä¸‹ä¸€ä¸ªå…ƒç´ éœ€è¦â€œè·¨è¿‡â€çš„å­—èŠ‚æ•°ã€‚

å›¾A-1ç®€å•åœ°è¯´æ˜äº†ndarrayçš„å†…éƒ¨ç»“æ„ã€‚

![å›¾A-1 Numpyçš„ndarrayå¯¹è±¡](https://gitee.com/wugenqiang/images/raw/master/01/1240-20201013185150181.png)


ä¾‹å¦‚ï¼Œä¸€ä¸ª10Ã—5çš„æ•°ç»„ï¼Œå…¶å½¢çŠ¶ä¸º(10,5)ï¼š
```python
In [10]: np.ones((10, 5)).shape
Out[10]: (10, 5)
```

ä¸€ä¸ªå…¸å‹çš„ï¼ˆCé¡ºåºï¼Œç¨åå°†è¯¦ç»†è®²è§£ï¼‰3Ã—4Ã—5çš„float64ï¼ˆ8ä¸ªå­—èŠ‚ï¼‰æ•°ç»„ï¼Œå…¶è·¨åº¦ä¸º(160,40,8) â€”â€” çŸ¥é“è·¨åº¦æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œé€šå¸¸ï¼Œ**è·¨åº¦åœ¨ä¸€ä¸ªè½´ä¸Šè¶Šå¤§ï¼Œæ²¿è¿™ä¸ªè½´è¿›è¡Œè®¡ç®—çš„å¼€é”€å°±è¶Šå¤§**ï¼š
```python
In [11]: np.ones((3, 4, 5), dtype=np.float64).strides
Out[11]: (160, 40, 8)
```

è™½ç„¶NumPyç”¨æˆ·å¾ˆå°‘ä¼šå¯¹æ•°ç»„çš„è·¨åº¦ä¿¡æ¯æ„Ÿå…´è¶£ï¼Œä½†å®ƒä»¬å´æ˜¯æ„å»ºéå¤åˆ¶å¼æ•°ç»„è§†å›¾çš„é‡è¦å› ç´ ã€‚è·¨åº¦ç”šè‡³å¯ä»¥æ˜¯è´Ÿæ•°ï¼Œè¿™æ ·ä¼šä½¿æ•°ç»„åœ¨å†…å­˜ä¸­åå‘ç§»åŠ¨ï¼Œæ¯”å¦‚åœ¨åˆ‡ç‰‡obj[::-1]æˆ–obj[:,::-1]ä¸­å°±æ˜¯è¿™æ ·çš„ã€‚

## NumPyæ•°æ®ç±»å‹ä½“ç³»

ä½ å¯èƒ½å¶å°”éœ€è¦æ£€æŸ¥æ•°ç»„ä¸­æ‰€åŒ…å«çš„æ˜¯å¦æ˜¯**æ•´æ•°ã€æµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²æˆ–Pythonå¯¹è±¡**ã€‚å› ä¸ºæµ®ç‚¹æ•°çš„ç§ç±»å¾ˆå¤šï¼ˆä»float16åˆ°float128ï¼‰ï¼Œåˆ¤æ–­dtypeæ˜¯å¦å±äºæŸä¸ªå¤§ç±»çš„å·¥ä½œéå¸¸ç¹çã€‚å¹¸è¿çš„æ˜¯ï¼Œdtypeéƒ½æœ‰ä¸€ä¸ªè¶…ç±»ï¼ˆæ¯”å¦‚np.integerå’Œnp.floatingï¼‰ï¼Œå®ƒä»¬å¯ä»¥è·Ÿnp.issubdtypeå‡½æ•°ç»“åˆä½¿ç”¨ï¼š
```python
In [12]: ints = np.ones(10, dtype=np.uint16)

In [13]: floats = np.ones(10, dtype=np.float32)

In [14]: np.issubdtype(ints.dtype, np.integer)
Out[14]: True

In [15]: np.issubdtype(floats.dtype, np.floating)
Out[15]: True
```

è°ƒç”¨dtypeçš„mroæ–¹æ³•å³å¯æŸ¥çœ‹å…¶æ‰€æœ‰çš„çˆ¶ç±»ï¼š
```python
In [16]: np.float64.mro()
Out[16]:
[numpy.float64,
 numpy.floating,
 numpy.inexact,
 numpy.number,
 numpy.generic,
 float,
 object]
```

ç„¶åå¾—åˆ°ï¼š
```python
In [17]: np.issubdtype(ints.dtype, np.number)
Out[17]: True
```

å¤§éƒ¨åˆ†NumPyç”¨æˆ·å®Œå…¨ä¸éœ€è¦äº†è§£è¿™äº›çŸ¥è¯†ï¼Œä½†æ˜¯è¿™äº›çŸ¥è¯†å¶å°”è¿˜æ˜¯èƒ½æ´¾ä¸Šç”¨åœºçš„ã€‚å›¾A-2è¯´æ˜äº†dtypeä½“ç³»ä»¥åŠçˆ¶å­ç±»å…³ç³»ã€‚

![å›¾A-2 NumPyçš„dtypeä½“ç³»](https://gitee.com/wugenqiang/images/raw/master/01/1240-20201013191615384.png)

# A.2 é«˜çº§æ•°ç»„æ“ä½œ

é™¤èŠ±å¼ç´¢å¼•ã€åˆ‡ç‰‡ã€å¸ƒå°”æ¡ä»¶å–å­é›†ç­‰æ“ä½œä¹‹å¤–ï¼Œæ•°ç»„çš„æ“ä½œæ–¹å¼è¿˜æœ‰å¾ˆå¤šã€‚è™½ç„¶pandasä¸­çš„é«˜çº§å‡½æ•°å¯ä»¥å¤„ç†æ•°æ®åˆ†æå·¥ä½œä¸­çš„è®¸å¤šé‡å‹ä»»åŠ¡ï¼Œä½†æœ‰æ—¶ä½ è¿˜æ˜¯éœ€è¦ç¼–å†™ä¸€äº›åœ¨ç°æœ‰åº“ä¸­æ‰¾ä¸åˆ°çš„æ•°æ®ç®—æ³•ã€‚

## æ•°ç»„é‡å¡‘

å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥æ— éœ€å¤åˆ¶ä»»ä½•æ•°æ®ï¼Œå°±å°†æ•°ç»„ä»ä¸€ä¸ªå½¢çŠ¶è½¬æ¢ä¸ºå¦ä¸€ä¸ªå½¢çŠ¶ã€‚åªéœ€å‘æ•°ç»„çš„å®ä¾‹æ–¹æ³•reshapeä¼ å…¥ä¸€ä¸ªè¡¨ç¤ºæ–°å½¢çŠ¶çš„å…ƒç»„å³å¯å®ç°è¯¥ç›®çš„ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æœ‰ä¸€ä¸ªä¸€ç»´æ•°ç»„ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å…¶é‡æ–°æ’åˆ—ä¸ºä¸€ä¸ªçŸ©é˜µï¼ˆç»“æœè§å›¾A-3ï¼‰ï¼š
```python
In [18]: arr = np.arange(8)

In [19]: arr
Out[19]: array([0, 1, 2, 3, 4, 5, 6, 7])

In [20]: arr.reshape((4, 2))
Out[20]: 
array([[0, 1],
       [2, 3],
       [4, 5],
       [6, 7]])
```

![å›¾A-3 æŒ‰Cé¡ºåºï¼ˆæŒ‰è¡Œï¼‰å’ŒæŒ‰Fortrané¡ºåºï¼ˆæŒ‰åˆ—ï¼‰è¿›è¡Œé‡å¡‘](https://gitee.com/wugenqiang/images/raw/master/01/1240-20201014192853651.png)

å¤šç»´æ•°ç»„ä¹Ÿèƒ½è¢«é‡å¡‘ï¼š
```python
In [21]: arr.reshape((4, 2)).reshape((2, 4))
Out[21]: 
array([[0, 1, 2, 3],
       [4, 5, 6, 7]])
```

ä½œä¸ºå‚æ•°çš„å½¢çŠ¶çš„å…¶ä¸­ä¸€ç»´å¯ä»¥æ˜¯ï¼1ï¼Œå®ƒè¡¨ç¤ºè¯¥ç»´åº¦çš„å¤§å°ç”±æ•°æ®æœ¬èº«æ¨æ–­è€Œæ¥ï¼š
```python
In [22]: arr = np.arange(15)

In [23]: arr.reshape((5, -1))
Out[23]: 
array([[ 0,  1,  2],
       [ 3,  4,  5],
       [ 6,  7,  8],
       [ 9, 10, 11],
       [12, 13, 14]])
```

ä¸reshapeå°†ä¸€ç»´æ•°ç»„è½¬æ¢ä¸ºå¤šç»´æ•°ç»„çš„è¿ç®—è¿‡ç¨‹ç›¸åçš„è¿ç®—é€šå¸¸ç§°ä¸ºæ‰å¹³åŒ–ï¼ˆflatteningï¼‰æˆ–æ•£å¼€ï¼ˆravelingï¼‰ï¼š
```python
In [27]: arr = np.arange(15).reshape((5, 3))

In [28]: arr
Out[28]: 
array([[ 0,  1,  2],
       [ 3,  4,  5],
       [ 6,  7,  8],
       [ 9, 10, 11],
       [12, 13, 14]])

In [29]: arr.ravel()
Out[29]: array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14])
```

å¦‚æœç»“æœä¸­çš„å€¼ä¸åŸå§‹æ•°ç»„ç›¸åŒï¼Œravelä¸ä¼šäº§ç”Ÿæºæ•°æ®çš„å‰¯æœ¬ã€‚flattenæ–¹æ³•çš„è¡Œä¸ºç±»ä¼¼äºravelï¼Œåªä¸è¿‡å®ƒæ€»æ˜¯è¿”å›æ•°æ®çš„å‰¯æœ¬ï¼š
```python
In [30]: arr.flatten()
Out[30]: array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14])
```

æ•°ç»„å¯ä»¥è¢«é‡å¡‘æˆ–æ•£å¼€ä¸ºåˆ«çš„é¡ºåºã€‚è¿™å¯¹NumPyæ–°æ‰‹æ¥è¯´æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¾®å¦™çš„é—®é¢˜ï¼Œæ‰€ä»¥åœ¨ä¸‹ä¸€å°èŠ‚ä¸­æˆ‘ä»¬å°†ä¸“é—¨è®²è§£è¿™ä¸ªé—®é¢˜ã€‚

## Cå’ŒFortrané¡ºåº

NumPyå…è®¸ä½ æ›´ä¸ºçµæ´»åœ°æ§åˆ¶æ•°æ®åœ¨å†…å­˜ä¸­çš„å¸ƒå±€ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒNumPyæ•°ç»„æ˜¯æŒ‰è¡Œä¼˜å…ˆé¡ºåºåˆ›å»ºçš„ã€‚åœ¨ç©ºé—´æ–¹é¢ï¼Œè¿™å°±æ„å‘³ç€ï¼Œå¯¹äºä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ¯è¡Œä¸­çš„æ•°æ®é¡¹æ˜¯è¢«å­˜æ”¾åœ¨ç›¸é‚»å†…å­˜ä½ç½®ä¸Šçš„ã€‚å¦ä¸€ç§é¡ºåºæ˜¯åˆ—ä¼˜å…ˆé¡ºåºï¼Œå®ƒæ„å‘³ç€æ¯åˆ—ä¸­çš„æ•°æ®é¡¹æ˜¯è¢«å­˜æ”¾åœ¨ç›¸é‚»å†…å­˜ä½ç½®ä¸Šçš„ã€‚

ç”±äºä¸€äº›å†å²åŸå› ï¼Œè¡Œå’Œåˆ—ä¼˜å…ˆé¡ºåºåˆåˆ†åˆ«ç§°ä¸ºCå’ŒFortrané¡ºåºã€‚åœ¨FORTRAN 77ä¸­ï¼ŒçŸ©é˜µå…¨éƒ½æ˜¯åˆ—ä¼˜å…ˆçš„ã€‚

åƒreshapeå’Œrevalè¿™æ ·çš„å‡½æ•°ï¼Œéƒ½å¯ä»¥æ¥å—ä¸€ä¸ªè¡¨ç¤ºæ•°ç»„æ•°æ®å­˜æ”¾é¡ºåºçš„orderå‚æ•°ã€‚ä¸€èˆ¬å¯ä»¥æ˜¯'C'æˆ–'F'ï¼ˆè¿˜æœ‰'A'å’Œ'K'ç­‰ä¸å¸¸ç”¨çš„é€‰é¡¹ï¼Œå…·ä½“è¯·å‚è€ƒNumPyçš„æ–‡æ¡£ï¼‰ã€‚å›¾A-3å¯¹æ­¤è¿›è¡Œäº†è¯´æ˜ï¼š
```python
In [31]: arr = np.arange(12).reshape((3, 4))

In [32]: arr
Out[32]: 
array([[ 0,  1,  2,  3],
       [ 4,  5,  6,  7],
       [ 8,  9, 10, 11]])

In [33]: arr.ravel()
Out[33]: array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11])

In [34]: arr.ravel('F')
Out[34]: array([ 0,  4,  8,  1,  5,  9,  2,  6, 10,  3,  7, 11])
```

![å›¾A-3 æŒ‰Cï¼ˆè¡Œä¼˜å…ˆï¼‰æˆ–Fortranï¼ˆåˆ—ä¼˜å…ˆï¼‰é¡ºåºè¿›è¡Œé‡å¡‘](https://gitee.com/wugenqiang/images/raw/master/01/1240-20201014194504260.png)

äºŒç»´æˆ–æ›´é«˜ç»´æ•°ç»„çš„é‡å¡‘è¿‡ç¨‹æ¯”è¾ƒä»¤äººè´¹è§£ï¼ˆè§å›¾A-3ï¼‰ã€‚Cå’ŒFortrané¡ºåºçš„å…³é”®åŒºåˆ«å°±æ˜¯ç»´åº¦çš„è¡Œè¿›é¡ºåºï¼š

- C/è¡Œä¼˜å…ˆé¡ºåºï¼šå…ˆç»è¿‡æ›´é«˜çš„ç»´åº¦ï¼ˆä¾‹å¦‚ï¼Œè½´1ä¼šå…ˆäºè½´0è¢«å¤„ç†ï¼‰ã€‚
- Fortran/åˆ—ä¼˜å…ˆé¡ºåºï¼šåç»è¿‡æ›´é«˜çš„ç»´åº¦ï¼ˆä¾‹å¦‚ï¼Œè½´0ä¼šå…ˆäºè½´1è¢«å¤„ç†ï¼‰ã€‚


## æ•°ç»„çš„åˆå¹¶å’Œæ‹†åˆ†

`numpy.concatenate`å¯ä»¥æŒ‰æŒ‡å®šè½´å°†ä¸€ä¸ªç”±æ•°ç»„ç»„æˆçš„åºåˆ—ï¼ˆå¦‚å…ƒç»„ã€åˆ—è¡¨ç­‰ï¼‰è¿æ¥åˆ°ä¸€èµ·ï¼š

```python
In [35]: arr1 = np.array([[1, 2, 3], [4, 5, 6]])

In [36]: arr2 = np.array([[7, 8, 9], [10, 11, 12]])

In [37]: np.concatenate([arr1, arr2], axis=0)
Out[37]: 
array([[ 1,  2,  3],
       [ 4,  5,  6],
       [ 7,  8,  9],
       [10, 11, 12]])

In [38]: np.concatenate([arr1, arr2], axis=1)
Out[38]: 
array([[ 1,  2,  3,  7,  8,  9],
       [ 4,  5,  6, 10, 11, 12]])
```

å¯¹äºå¸¸è§çš„è¿æ¥æ“ä½œï¼ŒNumPyæä¾›äº†ä¸€äº›æ¯”è¾ƒæ–¹ä¾¿çš„æ–¹æ³•ï¼ˆå¦‚`vstack`å’Œ`hstack`ï¼‰ã€‚å› æ­¤ï¼Œä¸Šé¢çš„è¿ç®—è¿˜å¯ä»¥è¡¨è¾¾ä¸ºï¼š
```python
In [39]: np.vstack((arr1, arr2))
Out[39]: 
array([[ 1,  2,  3],
       [ 4,  5,  6],
       [ 7,  8,  9],
       [10, 11, 12]])

In [40]: np.hstack((arr1, arr2))
Out[40]: 
array([[ 1,  2,  3,  7,  8,  9],
[ 4,  5,  6, 10, 11, 12]])
```

ä¸æ­¤ç›¸åï¼Œ`split`ç”¨äºå°†ä¸€ä¸ªæ•°ç»„æ²¿æŒ‡å®šè½´æ‹†åˆ†ä¸ºå¤šä¸ªæ•°ç»„ï¼š
```python
In [41]: arr = np.random.randn(5, 2)

In [42]: arr
Out[42]: 
array([[-0.2047,  0.4789],
       [-0.5194, -0.5557],
       [ 1.9658,  1.3934],
       [ 0.0929,  0.2817],
       [ 0.769 ,  1.2464]])

In [43]: first, second, third = np.split(arr, [1, 3])

In [44]: first
Out[44]: array([[-0.2047,  0.4789]])

In [45]: second
Out[45]: 
array([[-0.5194, -0.5557],
       [ 1.9658,  1.3934]])
In [46]: third
Out[46]: 
array([[ 0.0929,  0.2817],
       [ 0.769 ,  1.2464]])
```

ä¼ å…¥åˆ°np.splitçš„å€¼[1,3]æŒ‡ç¤ºåœ¨å“ªä¸ªç´¢å¼•å¤„åˆ†å‰²æ•°ç»„ã€‚

è¡¨A-1ä¸­åˆ—å‡ºäº†æ‰€æœ‰å…³äºæ•°ç»„è¿æ¥å’Œæ‹†åˆ†çš„å‡½æ•°ï¼Œå…¶ä¸­æœ‰äº›æ˜¯ä¸“é—¨ä¸ºäº†æ–¹ä¾¿å¸¸è§çš„è¿æ¥è¿ç®—è€Œæä¾›çš„ã€‚
                                                                    
![è¡¨A-1 æ•°ç»„è¿æ¥å‡½æ•°](https://gitee.com/wugenqiang/images/raw/master/01/1240-20201014200352394.png)

## å †å è¾…åŠ©ç±»ï¼šr_å’Œc_

NumPyå‘½åç©ºé—´ä¸­æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„å¯¹è±¡â€”â€”r_å’Œc_ï¼Œå®ƒä»¬å¯ä»¥ä½¿æ•°ç»„çš„å †å æ“ä½œæ›´ä¸ºç®€æ´ï¼š
```python
In [47]: arr = np.arange(6)

In [48]: arr1 = arr.reshape((3, 2))

In [49]: arr2 = np.random.randn(3, 2)

In [50]: np.r_[arr1, arr2]
Out[50]: 
array([[ 0.    ,  1.    ],
       [ 2.    ,  3.    ],
       [ 4.    ,  5.    ],
       [ 1.0072, -1.2962],
       [ 0.275 ,  0.2289],
       [ 1.3529,  0.8864]])

In [51]: np.c_[np.r_[arr1, arr2], arr]
Out[51]: 
array([[ 0.    ,  1.    ,  0.    ],
       [ 2.    ,  3.    ,  1.    ],
       [ 4.    ,  5.    ,  2.    ],
       [ 1.0072, -1.2962,  3.    ],
       [ 0.275 ,  0.2289,  4.    ],
       [ 1.3529,  0.8864,  5.    ]])
```

å®ƒè¿˜å¯ä»¥å°†åˆ‡ç‰‡è½¬æ¢æˆæ•°ç»„ï¼š
```python
In [52]: np.c_[1:6, -10:-5]
Out[52]: 
array([[  1, -10],
       [  2,  -9],
       [  3,  -8],
       [  4,  -7],
       [  5,  -6]])
```

r_å’Œc_çš„å…·ä½“åŠŸèƒ½è¯·å‚è€ƒå…¶æ–‡æ¡£ã€‚

## å…ƒç´ çš„é‡å¤æ“ä½œï¼štileå’Œrepeat

å¯¹æ•°ç»„è¿›è¡Œé‡å¤ä»¥äº§ç”Ÿæ›´å¤§æ•°ç»„çš„å·¥å…·ä¸»è¦æ˜¯repeatå’Œtileè¿™ä¸¤ä¸ªå‡½æ•°ã€‚repeatä¼šå°†æ•°ç»„ä¸­çš„å„ä¸ªå…ƒç´ é‡å¤ä¸€å®šæ¬¡æ•°ï¼Œä»è€Œäº§ç”Ÿä¸€ä¸ªæ›´å¤§çš„æ•°ç»„ï¼š
```python
In [53]: arr = np.arange(3)

In [54]: arr
Out[54]: array([0, 1, 2])

In [55]: arr.repeat(3)
Out[55]: array([0, 0, 0, 1, 1, 1, 2, 2, 2])
```

>ğŸ¦Š ç¬”è®°ï¼šè·Ÿå…¶ä»–æµè¡Œçš„æ•°ç»„ç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚MATLABï¼‰ä¸åŒï¼ŒNumPyä¸­å¾ˆå°‘éœ€è¦å¯¹æ•°ç»„è¿›è¡Œé‡å¤ï¼ˆreplicateï¼‰ã€‚è¿™ä¸»è¦æ˜¯å› ä¸ºå¹¿æ’­ï¼ˆbroadcastingï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­è®²è§£è¯¥æŠ€æœ¯ï¼‰èƒ½æ›´å¥½åœ°æ»¡è¶³è¯¥éœ€æ±‚ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œåˆ™å„å…ƒç´ å°±éƒ½ä¼šé‡å¤é‚£ä¹ˆå¤šæ¬¡ã€‚å¦‚æœä¼ å…¥çš„æ˜¯ä¸€ç»„æ•´æ•°ï¼Œåˆ™å„å…ƒç´ å°±å¯ä»¥é‡å¤ä¸åŒçš„æ¬¡æ•°ï¼š
```python
In [56]: arr.repeat([2, 3, 4])
Out[56]: array([0, 0, 1, 1, 1, 2, 2, 2, 2])
```

å¯¹äºå¤šç»´æ•°ç»„ï¼Œè¿˜å¯ä»¥è®©å®ƒä»¬çš„å…ƒç´ æ²¿æŒ‡å®šè½´é‡å¤ï¼š
```python
In [57]: arr = np.random.randn(2, 2)

In [58]: arr
Out[58]: 
array([[-2.0016, -0.3718],
       [ 1.669 , -0.4386]])

In [59]: arr.repeat(2, axis=0)
Out[59]: 
array([[-2.0016, -0.3718],
       [-2.0016, -0.3718],
       [ 1.669 , -0.4386],
       [ 1.669 , -0.4386]])
```

æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®è½´å‘ï¼Œåˆ™æ•°ç»„ä¼šè¢«æ‰å¹³åŒ–ï¼Œè¿™å¯èƒ½ä¸ä¼šæ˜¯ä½ æƒ³è¦çš„ç»“æœã€‚åŒæ ·ï¼Œåœ¨å¯¹å¤šç»´è¿›è¡Œé‡å¤æ—¶ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ç»„æ•´æ•°ï¼Œè¿™æ ·å°±ä¼šä½¿å„åˆ‡ç‰‡é‡å¤ä¸åŒçš„æ¬¡æ•°ï¼š
```python
In [60]: arr.repeat([2, 3], axis=0)
Out[60]: 
array([[-2.0016, -0.3718],
       [-2.0016, -0.3718],
       [ 1.669 , -0.4386],
       [ 1.669 , -0.4386],
       [ 1.669 , -0.4386]])

In [61]: arr.repeat([2, 3], axis=1)
Out[61]: 
array([[-2.0016, -2.0016, -0.3718, -0.3718, -0.3718],
       [ 1.669 ,  1.669 , -0.4386, -0.4386, -0.4386]])
```

tileçš„åŠŸèƒ½æ˜¯æ²¿æŒ‡å®šè½´å‘å †å æ•°ç»„çš„å‰¯æœ¬ã€‚ä½ å¯ä»¥å½¢è±¡åœ°å°†å…¶æƒ³è±¡æˆâ€œé“ºç“·ç –â€ï¼š
```python
In [62]: arr
Out[62]: 
array([[-2.0016, -0.3718],
       [ 1.669 , -0.4386]])

In [63]: np.tile(arr, 2)
Out[63]: 
array([[-2.0016, -0.3718, -2.0016, -0.3718],
       [ 1.669 , -0.4386,  1.669 , -0.4386]])
```

ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç“·ç –çš„æ•°é‡ã€‚å¯¹äºæ ‡é‡ï¼Œç“·ç –æ˜¯æ°´å¹³é“ºè®¾çš„ï¼Œè€Œä¸æ˜¯å‚ç›´é“ºè®¾ã€‚å®ƒå¯ä»¥æ˜¯ä¸€ä¸ªè¡¨ç¤ºâ€œé“ºè®¾â€å¸ƒå±€çš„å…ƒç»„ï¼š
```python
In [64]: arr
Out[64]: 
array([[-2.0016, -0.3718],
       [ 1.669 , -0.4386]])

In [65]: np.tile(arr, (2, 1))
Out[65]: 
array([[-2.0016, -0.3718],
       [ 1.669 , -0.4386],
       [-2.0016, -0.3718],
       [ 1.669 , -0.4386]])

In [66]: np.tile(arr, (3, 2))
Out[66]: 
array([[-2.0016, -0.3718, -2.0016, -0.3718],
       [ 1.669 , -0.4386,  1.669 , -0.4386],
       [-2.0016, -0.3718, -2.0016, -0.3718],
       [ 1.669 , -0.4386,  1.669 , -0.4386],
       [-2.0016, -0.3718, -2.0016, -0.3718],
       [ 1.669 , -0.4386,  1.669 , -0.4386]])
```

## èŠ±å¼ç´¢å¼•çš„ç­‰ä»·å‡½æ•°ï¼štakeå’Œput

åœ¨ç¬¬4ç« ä¸­æˆ‘ä»¬è®²è¿‡ï¼Œè·å–å’Œè®¾ç½®æ•°ç»„å­é›†çš„ä¸€ä¸ªåŠæ³•æ˜¯é€šè¿‡æ•´æ•°æ•°ç»„ä½¿ç”¨èŠ±å¼ç´¢å¼•ï¼š
```python
In [67]: arr = np.arange(10) * 100

In [68]: inds = [7, 1, 2, 6]

In [69]: arr[inds]
Out[69]: array([700, 100, 200, 600])
```

ndarrayè¿˜æœ‰å…¶å®ƒæ–¹æ³•ç”¨äºè·å–å•ä¸ªè½´å‘ä¸Šçš„é€‰åŒºï¼š
```python
In [70]: arr.take(inds)
Out[70]: array([700, 100, 200, 600])

In [71]: arr.put(inds, 42)

In [72]: arr
Out[72]: array([  0,  42,  42, 300, 400, 500,  42,  42,800, 900])

In [73]: arr.put(inds, [40, 41, 42, 43])

In [74]: arr
Out[74]: array([  0,  41,  42, 300, 400, 500,  43,  40, 800, 900])
```

è¦åœ¨å…¶å®ƒè½´ä¸Šä½¿ç”¨takeï¼Œåªéœ€ä¼ å…¥axiså…³é”®å­—å³å¯ï¼š
```python
In [75]: inds = [2, 0, 2, 1]

In [76]: arr = np.random.randn(2, 4)

In [77]: arr
Out[77]: 
array([[-0.5397,  0.477 ,  3.2489, -1.0212],
       [-0.5771,  0.1241,  0.3026,  0.5238]])

In [78]: arr.take(inds, axis=1)
Out[78]: 
array([[ 3.2489, -0.5397,  3.2489,  0.477 ],
       [ 0.3026, -0.5771,  0.3026,  0.1241]])
```

putä¸æ¥å—axiså‚æ•°ï¼Œå®ƒåªä¼šåœ¨æ•°ç»„çš„æ‰å¹³åŒ–ç‰ˆæœ¬ï¼ˆä¸€ç»´ï¼ŒCé¡ºåºï¼‰ä¸Šè¿›è¡Œç´¢å¼•ã€‚å› æ­¤ï¼Œåœ¨éœ€è¦ç”¨å…¶ä»–è½´å‘çš„ç´¢å¼•è®¾ç½®å…ƒç´ æ—¶ï¼Œæœ€å¥½è¿˜æ˜¯ä½¿ç”¨èŠ±å¼ç´¢å¼•ã€‚

# A.3 å¹¿æ’­

å¹¿æ’­ï¼ˆbroadcastingï¼‰æŒ‡çš„æ˜¯ä¸åŒå½¢çŠ¶çš„æ•°ç»„ä¹‹é—´çš„ç®—æœ¯è¿ç®—çš„æ‰§è¡Œæ–¹å¼ã€‚å®ƒæ˜¯ä¸€ç§éå¸¸å¼ºå¤§çš„åŠŸèƒ½ï¼Œä½†ä¹Ÿå®¹æ˜“ä»¤äººè¯¯è§£ï¼Œå³ä½¿æ˜¯ç»éªŒä¸°å¯Œçš„è€æ‰‹ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å°†æ ‡é‡å€¼è·Ÿæ•°ç»„åˆå¹¶æ—¶å°±ä¼šå‘ç”Ÿæœ€ç®€å•çš„å¹¿æ’­ï¼š
```python
In [79]: arr = np.arange(5)

In [80]: arr
Out[80]: array([0, 1, 2, 3, 4])

In [81]: arr * 4
Out[81]: array([ 0,  4,  8, 12, 16])
```

è¿™é‡Œæˆ‘ä»¬è¯´ï¼šåœ¨è¿™ä¸ªä¹˜æ³•è¿ç®—ä¸­ï¼Œæ ‡é‡å€¼4è¢«å¹¿æ’­åˆ°äº†å…¶ä»–æ‰€æœ‰çš„å…ƒç´ ä¸Šã€‚

çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‡å»åˆ—å¹³å‡å€¼çš„æ–¹å¼å¯¹æ•°ç»„çš„æ¯ä¸€åˆ—è¿›è¡Œè·å¹³åŒ–å¤„ç†ã€‚è¿™ä¸ªé—®é¢˜è§£å†³èµ·æ¥éå¸¸ç®€å•ï¼š
```python
In [82]: arr = np.random.randn(4, 3)

In [83]: arr.mean(0)
Out[83]: array([-0.3928, -0.3824, -0.8768])

In [84]: demeaned = arr - arr.mean(0)

In [85]: demeaned
Out[85]: 
array([[ 0.3937,  1.7263,  0.1633],
       [-0.4384, -1.9878, -0.9839],
       [-0.468 ,  0.9426, -0.3891],
       [ 0.5126, -0.6811,  1.2097]])

In [86]: demeaned.mean(0)
Out[86]: array([-0.,  0., -0.])
```

å›¾A-4å½¢è±¡åœ°å±•ç¤ºäº†è¯¥è¿‡ç¨‹ã€‚ç”¨å¹¿æ’­çš„æ–¹å¼å¯¹è¡Œè¿›è¡Œè·å¹³åŒ–å¤„ç†ä¼šç¨å¾®éº»çƒ¦ä¸€äº›ã€‚å¹¸è¿çš„æ˜¯ï¼Œåªè¦éµå¾ªä¸€å®šçš„è§„åˆ™ï¼Œä½ç»´åº¦çš„å€¼æ˜¯å¯ä»¥è¢«å¹¿æ’­åˆ°æ•°ç»„çš„ä»»æ„ç»´åº¦çš„ï¼ˆæ¯”å¦‚å¯¹äºŒç»´æ•°ç»„å„åˆ—å‡å»è¡Œå¹³å‡å€¼ï¼‰ã€‚

![å›¾A-4 ä¸€ç»´æ•°ç»„åœ¨è½´0ä¸Šçš„å¹¿æ’­](https://gitee.com/wugenqiang/images/raw/master/01/1240-20201014201122073.png)


äºæ˜¯å°±å¾—åˆ°äº†ï¼š

![](https://gitee.com/wugenqiang/images/raw/master/01/1240-20201014201130724.png)

è™½ç„¶æˆ‘æ˜¯ä¸€åç»éªŒä¸°å¯Œçš„NumPyè€æ‰‹ï¼Œä½†ç»å¸¸è¿˜æ˜¯å¾—åœä¸‹æ¥ç”»å¼ å›¾å¹¶æƒ³æƒ³å¹¿æ’­çš„åŸåˆ™ã€‚å†æ¥çœ‹ä¸€ä¸‹æœ€åé‚£ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ å¸Œæœ›å¯¹å„è¡Œå‡å»é‚£ä¸ªå¹³å‡å€¼ã€‚ç”±äºarr.mean(0)çš„é•¿åº¦ä¸º3ï¼Œæ‰€ä»¥å®ƒå¯ä»¥åœ¨0è½´å‘ä¸Šè¿›è¡Œå¹¿æ’­ï¼šå› ä¸ºarrçš„åç¼˜ç»´åº¦æ˜¯3ï¼Œæ‰€ä»¥å®ƒä»¬æ˜¯å…¼å®¹çš„ã€‚æ ¹æ®è¯¥åŸåˆ™ï¼Œè¦åœ¨1è½´å‘ä¸Šåšå‡æ³•ï¼ˆå³å„è¡Œå‡å»è¡Œå¹³å‡å€¼ï¼‰ï¼Œè¾ƒå°çš„é‚£ä¸ªæ•°ç»„çš„å½¢çŠ¶å¿…é¡»æ˜¯(4,1)ï¼š
```python
In [87]: arr
Out[87]: 
array([[ 0.0009,  1.3438, -0.7135],
       [-0.8312, -2.3702, -1.8608],
       [-0.8608,  0.5601, -1.2659],
       [ 0.1198, -1.0635,  0.3329]])

In [88]: row_means = arr.mean(1)

In [89]: row_means.shape
Out[89]: (4,)

In [90]: row_means.reshape((4, 1))
Out[90]: 
array([[ 0.2104],
       [-1.6874],
       [-0.5222],
       [-0.2036]])

In [91]: demeaned = arr - row_means.reshape((4, 1))

In [92]: demeaned.mean(1)
Out[92]: array([ 0., -0.,  0.,  0.])
```

å›¾A-5è¯´æ˜äº†è¯¥è¿ç®—çš„è¿‡ç¨‹ã€‚

![å›¾A-5 äºŒç»´æ•°ç»„åœ¨è½´1ä¸Šçš„å¹¿æ’­](https://gitee.com/wugenqiang/images/raw/master/01/1240-20201014201328232.png)

å›¾A-6å±•ç¤ºäº†å¦å¤–ä¸€ç§æƒ…å†µï¼Œè¿™æ¬¡æ˜¯åœ¨ä¸€ä¸ªä¸‰ç»´æ•°ç»„ä¸Šæ²¿0è½´å‘åŠ ä¸Šä¸€ä¸ªäºŒç»´æ•°ç»„ã€‚

![å›¾A-6 ä¸‰ç»´æ•°ç»„åœ¨è½´0ä¸Šçš„å¹¿æ’­](https://gitee.com/wugenqiang/images/raw/master/01/1240-20201014201355589.png)

## æ²¿å…¶å®ƒè½´å‘å¹¿æ’­

é«˜ç»´åº¦æ•°ç»„çš„å¹¿æ’­ä¼¼ä¹æ›´éš¾ä»¥ç†è§£ï¼Œè€Œå®é™…ä¸Šå®ƒä¹Ÿæ˜¯éµå¾ªå¹¿æ’­åŸåˆ™çš„ã€‚å¦‚æœä¸ç„¶ï¼Œä½ å°±ä¼šå¾—åˆ°ä¸‹é¢è¿™æ ·ä¸€ä¸ªé”™è¯¯ï¼š
```python
In [93]: arr - arr.mean(1)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-93-7b87b85a20b2> in <module>()
----> 1 arr - arr.mean(1)
ValueError: operands could not be broadcast together with shapes (4,3) (4,)
```

äººä»¬ç»å¸¸éœ€è¦é€šè¿‡ç®—æœ¯è¿ç®—è¿‡ç¨‹å°†è¾ƒä½ç»´åº¦çš„æ•°ç»„åœ¨é™¤0è½´ä»¥å¤–çš„å…¶ä»–è½´å‘ä¸Šå¹¿æ’­ã€‚æ ¹æ®å¹¿æ’­çš„åŸåˆ™ï¼Œè¾ƒå°æ•°ç»„çš„â€œå¹¿æ’­ç»´â€å¿…é¡»ä¸º1ã€‚åœ¨ä¸Šé¢é‚£ä¸ªè¡Œè·å¹³åŒ–çš„ä¾‹å­ä¸­ï¼Œè¿™å°±æ„å‘³ç€è¦å°†è¡Œå¹³å‡å€¼çš„å½¢çŠ¶å˜æˆ(4,1)è€Œä¸æ˜¯(4,)ï¼š
```python
In [94]: arr - arr.mean(1).reshape((4, 1))
Out[94]: 
array([[-0.2095,  1.1334, -0.9239],
       [ 0.8562, -0.6828, -0.1734],
       [-0.3386,  1.0823, -0.7438],
       [ 0.3234, -0.8599,  0.5365]])
```

å¯¹äºä¸‰ç»´çš„æƒ…å†µï¼Œåœ¨ä¸‰ç»´ä¸­çš„ä»»ä½•ä¸€ç»´ä¸Šå¹¿æ’­å…¶å®ä¹Ÿå°±æ˜¯å°†æ•°æ®é‡å¡‘ä¸ºå…¼å®¹çš„å½¢çŠ¶è€Œå·²ã€‚å›¾A-7è¯´æ˜äº†è¦åœ¨ä¸‰ç»´æ•°ç»„å„ç»´åº¦ä¸Šå¹¿æ’­çš„å½¢çŠ¶éœ€æ±‚ã€‚

![å›¾A-7ï¼šèƒ½åœ¨è¯¥ä¸‰ç»´æ•°ç»„ä¸Šå¹¿æ’­çš„äºŒç»´æ•°ç»„çš„å½¢çŠ¶](https://gitee.com/wugenqiang/images/raw/master/01/1240-20201014202009833.png)

äºæ˜¯å°±æœ‰äº†ä¸€ä¸ªéå¸¸æ™®éçš„é—®é¢˜ï¼ˆå°¤å…¶æ˜¯åœ¨é€šç”¨ç®—æ³•ä¸­ï¼‰ï¼Œå³ä¸“é—¨ä¸ºäº†å¹¿æ’­è€Œæ·»åŠ ä¸€ä¸ªé•¿åº¦ä¸º1çš„æ–°è½´ã€‚è™½ç„¶reshapeæ˜¯ä¸€ä¸ªåŠæ³•ï¼Œä½†æ’å…¥è½´éœ€è¦æ„é€ ä¸€ä¸ªè¡¨ç¤ºæ–°å½¢çŠ¶çš„å…ƒç»„ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆéƒé—·çš„è¿‡ç¨‹ã€‚å› æ­¤ï¼ŒNumPyæ•°ç»„æä¾›äº†ä¸€ç§é€šè¿‡ç´¢å¼•æœºåˆ¶æ’å…¥è½´çš„ç‰¹æ®Šè¯­æ³•ã€‚ä¸‹é¢è¿™æ®µä»£ç é€šè¿‡ç‰¹æ®Šçš„np.newaxiså±æ€§ä»¥åŠâ€œå…¨â€åˆ‡ç‰‡æ¥æ’å…¥æ–°è½´ï¼š
```python
In [95]: arr = np.zeros((4, 4))

In [96]: arr_3d = arr[:, np.newaxis, :]

In [97]: arr_3d.shape
Out[97]: (4, 1, 4)

In [98]: arr_1d = np.random.normal(size=3)

In [99]: arr_1d[:, np.newaxis]
Out[99]: 
array([[-2.3594],
       [-0.1995],
       [-1.542 ]])

In [100]: arr_1d[np.newaxis, :]
Out[100]: array([[-2.3594, -0.1995, -1.542 ]])
```

å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªä¸‰ç»´æ•°ç»„ï¼Œå¹¶å¸Œæœ›å¯¹è½´2è¿›è¡Œè·å¹³åŒ–ï¼Œé‚£ä¹ˆåªéœ€è¦ç¼–å†™ä¸‹é¢è¿™æ ·çš„ä»£ç å°±å¯ä»¥äº†ï¼š
```python
In [101]: arr = np.random.randn(3, 4, 5)

In [102]: depth_means = arr.mean(2)

In [103]: depth_means
Out[103]: 
array([[-0.4735,  0.3971, -0.0228,  0.2001],
       [-0.3521, -0.281 , -0.071 , -0.1586],
       [ 0.6245,  0.6047,  0.4396, -0.2846]])

In [104]: depth_means.shape
Out[104]: (3, 4)

In [105]: demeaned = arr - depth_means[:, :, np.newaxis]

In [106]: demeaned.mean(2)
Out[106]: 
array([[ 0.,  0., -0., -0.],
       [ 0.,  0., -0.,  0.],
       [ 0.,  0., -0., -0.]])
```

æœ‰äº›è¯»è€…å¯èƒ½ä¼šæƒ³ï¼Œåœ¨å¯¹æŒ‡å®šè½´è¿›è¡Œè·å¹³åŒ–æ—¶ï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ—¢é€šç”¨åˆä¸ç‰ºç‰²æ€§èƒ½çš„æ–¹æ³•å‘¢ï¼Ÿå®é™…ä¸Šæ˜¯æœ‰çš„ï¼Œä½†éœ€è¦ä¸€äº›ç´¢å¼•æ–¹é¢çš„æŠ€å·§ï¼š
```python
def demean_axis(arr, axis=0):
    means = arr.mean(axis)

    # This generalizes things like [:, :, np.newaxis] to N dimensions
    indexer = [slice(None)] * arr.ndim
    indexer[axis] = np.newaxis
    return arr - means[indexer]
```

## é€šè¿‡å¹¿æ’­è®¾ç½®æ•°ç»„çš„å€¼

ç®—æœ¯è¿ç®—æ‰€éµå¾ªçš„å¹¿æ’­åŸåˆ™åŒæ ·ä¹Ÿé€‚ç”¨äºé€šè¿‡ç´¢å¼•æœºåˆ¶è®¾ç½®æ•°ç»„å€¼çš„æ“ä½œã€‚å¯¹äºæœ€ç®€å•çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š
```python
In [107]: arr = np.zeros((4, 3))

In [108]: arr[:] = 5

In [109]: arr
Out[109]: 
array([[ 5.,  5.,  5.],
       [ 5.,  5.,  5.],
       [ 5.,  5.,  5.],
       [ 5.,  5.,  5.]])
```

ä½†æ˜¯ï¼Œå‡è®¾æˆ‘ä»¬æƒ³è¦ç”¨ä¸€ä¸ªä¸€ç»´æ•°ç»„æ¥è®¾ç½®ç›®æ ‡æ•°ç»„çš„å„åˆ—ï¼Œåªè¦ä¿è¯å½¢çŠ¶å…¼å®¹å°±å¯ä»¥äº†ï¼š
```python
In [110]: col = np.array([1.28, -0.42, 0.44, 1.6])
In [111]: arr[:] = col[:, np.newaxis]

In [112]: arr
Out[112]: 
array([[ 1.28,  1.28,  1.28],
       [-0.42, -0.42, -0.42],
       [ 0.44,  0.44,  0.44],
       [ 1.6 ,  1.6 ,  1.6 ]])

In [113]: arr[:2] = [[-1.37], [0.509]]

In [114]: arr
Out[114]: 
array([[-1.37 , -1.37 , -1.37 ],
       [ 0.509,  0.509,  0.509],
       [ 0.44 ,  0.44 ,  0.44 ],
       [ 1.6  ,  1.6  ,  1.6  ]])
```

# A.4 ufuncé«˜çº§åº”ç”¨

è™½ç„¶è®¸å¤šNumPyç”¨æˆ·åªä¼šç”¨åˆ°é€šç”¨å‡½æ•°æ‰€æä¾›çš„å¿«é€Ÿçš„å…ƒç´ çº§è¿ç®—ï¼Œä½†é€šç”¨å‡½æ•°å®é™…ä¸Šè¿˜æœ‰ä¸€äº›é«˜çº§ç”¨æ³•èƒ½ä½¿æˆ‘ä»¬ä¸¢å¼€å¾ªç¯è€Œç¼–å†™å‡ºæ›´ä¸ºç®€æ´çš„ä»£ç ã€‚

## ufuncå®ä¾‹æ–¹æ³•

NumPyçš„å„ä¸ªäºŒå…ƒufuncéƒ½æœ‰ä¸€äº›ç”¨äºæ‰§è¡Œç‰¹å®šçŸ¢é‡åŒ–è¿ç®—çš„ç‰¹æ®Šæ–¹æ³•ã€‚è¡¨A-2æ±‡æ€»äº†è¿™äº›æ–¹æ³•ï¼Œä¸‹é¢æˆ‘å°†é€šè¿‡å‡ ä¸ªå…·ä½“çš„ä¾‹å­å¯¹å®ƒä»¬è¿›è¡Œè¯´æ˜ã€‚

reduceæ¥å—ä¸€ä¸ªæ•°ç»„å‚æ•°ï¼Œå¹¶é€šè¿‡ä¸€ç³»åˆ—çš„äºŒå…ƒè¿ç®—å¯¹å…¶å€¼è¿›è¡Œèšåˆï¼ˆå¯æŒ‡æ˜è½´å‘ï¼‰ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨np.add.reduceå¯¹æ•°ç»„ä¸­å„ä¸ªå…ƒç´ è¿›è¡Œæ±‚å’Œï¼š
```python
In [115]: arr = np.arange(10)

In [116]: np.add.reduce(arr)
Out[116]: 45

In [117]: arr.sum()
Out[117]: 45
```

èµ·å§‹å€¼å–å†³äºufuncï¼ˆå¯¹äºaddçš„æƒ…å†µï¼Œå°±æ˜¯0ï¼‰ã€‚å¦‚æœè®¾ç½®äº†è½´å·ï¼Œçº¦ç®€è¿ç®—å°±ä¼šæ²¿è¯¥è½´å‘æ‰§è¡Œã€‚è¿™å°±ä½¿ä½ èƒ½ç”¨ä¸€ç§æ¯”è¾ƒç®€æ´çš„æ–¹å¼å¾—åˆ°æŸäº›é—®é¢˜çš„ç­”æ¡ˆã€‚åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç”¨np.logical_andæ£€æŸ¥æ•°ç»„å„è¡Œä¸­çš„å€¼æ˜¯å¦æ˜¯æœ‰åºçš„ï¼š
```python
In [118]: np.random.seed(12346)  # for reproducibility

In [119]: arr = np.random.randn(5, 5)

In [120]: arr[::2].sort(1) # sort a few rows

In [121]: arr[:, :-1] < arr[:, 1:]
Out[121]: 
array([[ True,  True,  True,  True],
       [False,  True, False, False],
       [ True,  True,  True,  True],
       [ True, False,  True,  True],
       [ True,  True,  True,  True]], dtype=bool)

In [122]: np.logical_and.reduce(arr[:, :-1] < arr[:, 1:], axis=1)
Out[122]: array([ True, False,  True, False,  True], dtype=bool)
```

æ³¨æ„ï¼Œlogical_and.reduceè·Ÿallæ–¹æ³•æ˜¯ç­‰ä»·çš„ã€‚

ccumulateè·Ÿreduceçš„å…³ç³»å°±åƒcumsumè·Ÿsumçš„å…³ç³»é‚£æ ·ã€‚å®ƒäº§ç”Ÿä¸€ä¸ªè·ŸåŸæ•°ç»„å¤§å°ç›¸åŒçš„ä¸­é—´â€œç´¯è®¡â€å€¼æ•°ç»„ï¼š
```python
In [123]: arr = np.arange(15).reshape((3, 5))

In [124]: np.add.accumulate(arr, axis=1)
Out[124]: 
array([[ 0,  1,  3,  6, 10],
       [ 5, 11, 18, 26, 35],
       [10, 21, 33, 46, 60]])
```

outerç”¨äºè®¡ç®—ä¸¤ä¸ªæ•°ç»„çš„å‰ç§¯ï¼š
```python
In [125]: arr = np.arange(3).repeat([1, 2, 2])

In [126]: arr
Out[126]: array([0, 1, 1, 2, 2])

In [127]: np.multiply.outer(arr, np.arange(5))
Out[127]: 
array([[0, 0, 0, 0, 0],
       [0, 1, 2, 3, 4],
       [0, 1, 2, 3, 4],
       [0, 2, 4, 6, 8],
       [0, 2, 4, 6, 8]])
```

outerè¾“å‡ºç»“æœçš„ç»´åº¦æ˜¯ä¸¤ä¸ªè¾“å…¥æ•°æ®çš„ç»´åº¦ä¹‹å’Œï¼š
```python
In [128]: x, y = np.random.randn(3, 4), np.random.randn(5)

In [129]: result = np.subtract.outer(x, y)

In [130]: result.shape
Out[130]: (3, 4, 5)
```

æœ€åä¸€ä¸ªæ–¹æ³•reduceatç”¨äºè®¡ç®—â€œå±€éƒ¨çº¦ç®€â€ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¯¹æ•°æ®å„åˆ‡ç‰‡è¿›è¡Œèšåˆçš„groupbyè¿ç®—ã€‚å®ƒæ¥å—ä¸€ç»„ç”¨äºæŒ‡ç¤ºå¦‚ä½•å¯¹å€¼è¿›è¡Œæ‹†åˆ†å’Œèšåˆçš„â€œé¢å…ƒè¾¹ç•Œâ€ï¼š
```python
In [131]: arr = np.arange(10)

In [132]: np.add.reduceat(arr, [0, 5, 8])
Out[132]: array([10, 18, 17])
```

æœ€ç»ˆç»“æœæ˜¯åœ¨arr[0:5]ã€arr[5:8]ä»¥åŠarr[8:]ä¸Šæ‰§è¡Œçš„çº¦ç®€ã€‚è·Ÿå…¶ä»–æ–¹æ³•ä¸€æ ·ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªaxiså‚æ•°ï¼š
```python
In [133]: arr = np.multiply.outer(np.arange(4), np.arange(5))

In [134]: arr
Out[134]: 
array([[ 0,  0,  0,  0,  0],
       [ 0,  1,  2,  3,  4],
       [ 0,  2,  4,  6,  8],
       [ 0,  3,  6,  9, 12]])

In [135]: np.add.reduceat(arr, [0, 2, 4], axis=1)
Out[135]: 
array([[ 0,  0,  0],
       [ 1,  5,  4],
       [ 2, 10,  8],
       [ 3, 15, 12]])
```

è¡¨A-2æ€»ç»“äº†éƒ¨åˆ†çš„ufuncæ–¹æ³•ã€‚


![è¡¨A ufuncæ–¹æ³•](https://gitee.com/wugenqiang/images/raw/master/01/1240-20201014203408335.png)

## ç¼–å†™æ–°çš„ufunc

æœ‰å¤šç§æ–¹æ³•å¯ä»¥è®©ä½ ç¼–å†™è‡ªå·±çš„NumPy ufuncsã€‚æœ€å¸¸è§çš„æ˜¯ä½¿ç”¨NumPy C APIï¼Œä½†å®ƒè¶…è¶Šäº†æœ¬ä¹¦çš„èŒƒå›´ã€‚åœ¨æœ¬èŠ‚ï¼Œæˆ‘ä»¬è®²çº¯ç²¹çš„Python ufuncã€‚

numpy.frompyfuncæ¥å—ä¸€ä¸ªPythonå‡½æ•°ä»¥åŠä¸¤ä¸ªåˆ†åˆ«è¡¨ç¤ºè¾“å…¥è¾“å‡ºå‚æ•°æ•°é‡çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªèƒ½å¤Ÿå®ç°å…ƒç´ çº§åŠ æ³•çš„ç®€å•å‡½æ•°ï¼š
```python
In [136]: def add_elements(x, y):
   .....:     return x + y

In [137]: add_them = np.frompyfunc(add_elements, 2, 1)

In [138]: add_them(np.arange(8), np.arange(8))
Out[138]: array([0, 2, 4, 6, 8, 10, 12, 14], dtype=object)
```

ç”¨frompyfuncåˆ›å»ºçš„å‡½æ•°æ€»æ˜¯è¿”å›Pythonå¯¹è±¡æ•°ç»„ï¼Œè¿™ä¸€ç‚¹å¾ˆä¸æ–¹ä¾¿ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªåŠæ³•ï¼Œå³numpy.vectorizeã€‚è™½ç„¶æ²¡æœ‰frompyfuncé‚£ä¹ˆå¼ºå¤§ï¼Œä½†å¯ä»¥è®©ä½ æŒ‡å®šè¾“å‡ºç±»å‹ï¼š
```python
In [139]: add_them = np.vectorize(add_elements, otypes=[np.float64])

In [140]: add_them(np.arange(8), np.arange(8))
Out[140]: array([  0.,   2.,   4.,   6.,   8.,  10.,  12.,  14.])
```

è™½ç„¶è¿™ä¸¤ä¸ªå‡½æ•°æä¾›äº†ä¸€ç§åˆ›å»ºufuncå‹å‡½æ•°çš„æ‰‹æ®µï¼Œä½†å®ƒä»¬éå¸¸æ…¢ï¼Œå› ä¸ºå®ƒä»¬åœ¨è®¡ç®—æ¯ä¸ªå…ƒç´ æ—¶éƒ½è¦æ‰§è¡Œä¸€æ¬¡Pythonå‡½æ•°è°ƒç”¨ï¼Œè¿™å°±ä¼šæ¯”NumPyè‡ªå¸¦çš„åŸºäºCçš„ufuncæ…¢å¾ˆå¤šï¼š
```python
In [141]: arr = np.random.randn(10000)

In [142]: %timeit add_them(arr, arr)
4.12 ms +- 182 us per loop (mean +- std. dev. of 7 runs, 100 loops each)

In [143]: %timeit np.add(arr, arr)
6.89 us +- 504 ns per loop (mean +- std. dev. of 7 runs, 100000 loops each)
```

æœ¬ç« çš„åé¢ï¼Œæˆ‘ä¼šä»‹ç»ä½¿ç”¨Numbaï¼ˆhttp://numba.pydata.org/ï¼‰ï¼Œåˆ›å»ºå¿«é€ŸPython ufuncsã€‚

# A.5 ç»“æ„åŒ–å’Œè®°å½•å¼æ•°ç»„

ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°äº†ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬æ‰€è®¨è®ºçš„ndarrayéƒ½æ˜¯ä¸€ç§åŒè´¨æ•°æ®å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å®ƒæ‰€è¡¨ç¤ºçš„å†…å­˜å—ä¸­ï¼Œå„å…ƒç´ å ç”¨çš„å­—èŠ‚æ•°ç›¸åŒï¼ˆå…·ä½“æ ¹æ®dtypeè€Œå®šï¼‰ã€‚ä»è¡¨é¢ä¸Šçœ‹ï¼Œå®ƒä¼¼ä¹ä¸èƒ½ç”¨äºè¡¨ç¤ºå¼‚è´¨æˆ–è¡¨æ ¼å‹çš„æ•°æ®ã€‚ç»“æ„åŒ–æ•°ç»„æ˜¯ä¸€ç§ç‰¹æ®Šçš„ndarrayï¼Œå…¶ä¸­çš„å„ä¸ªå…ƒç´ å¯ä»¥è¢«çœ‹åšCè¯­è¨€ä¸­çš„ç»“æ„ä½“ï¼ˆstructï¼Œè¿™å°±æ˜¯â€œç»“æ„åŒ–â€çš„ç”±æ¥ï¼‰æˆ–SQLè¡¨ä¸­å¸¦æœ‰å¤šä¸ªå‘½åå­—æ®µçš„è¡Œï¼š
```python
In [144]: dtype = [('x', np.float64), ('y', np.int32)]

In [145]: sarr = np.array([(1.5, 6), (np.pi, -2)], dtype=dtype)

In [146]: sarr
Out[146]: 
array([( 1.5   ,  6), ( 3.1416, -2)],
      dtype=[('x', '<f8'), ('y', '<i4')])
```

å®šä¹‰ç»“æ„åŒ–dtypeï¼ˆè¯·å‚è€ƒNumPyçš„åœ¨çº¿æ–‡æ¡£ï¼‰çš„æ–¹å¼æœ‰å¾ˆå¤šã€‚æœ€å…¸å‹çš„åŠæ³•æ˜¯å…ƒç»„åˆ—è¡¨ï¼Œå„å…ƒç»„çš„æ ¼å¼ä¸º(field_name,field_data_type)ã€‚è¿™æ ·ï¼Œæ•°ç»„çš„å…ƒç´ å°±æˆäº†å…ƒç»„å¼çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸­å„ä¸ªå…ƒç´ å¯ä»¥åƒå­—å…¸é‚£æ ·è¿›è¡Œè®¿é—®ï¼š
```python
In [147]: sarr[0]
Out[147]: ( 1.5, 6)

In [148]: sarr[0]['y']
Out[148]: 6
```

å­—æ®µåä¿å­˜åœ¨dtype.nameså±æ€§ä¸­ã€‚åœ¨è®¿é—®ç»“æ„åŒ–æ•°ç»„çš„æŸä¸ªå­—æ®µæ—¶ï¼Œè¿”å›çš„æ˜¯è¯¥æ•°æ®çš„è§†å›¾ï¼Œæ‰€ä»¥ä¸ä¼šå‘ç”Ÿæ•°æ®å¤åˆ¶ï¼š
```python
In [149]: sarr['x']
Out[149]: array([ 1.5   ,  3.1416])
```

## åµŒå¥—dtypeå’Œå¤šç»´å­—æ®µ

åœ¨å®šä¹‰ç»“æ„åŒ–dtypeæ—¶ï¼Œä½ å¯ä»¥å†è®¾ç½®ä¸€ä¸ªå½¢çŠ¶ï¼ˆå¯ä»¥æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå…ƒç»„ï¼‰ï¼š
```python
In [150]: dtype = [('x', np.int64, 3), ('y', np.int32)]

In [151]: arr = np.zeros(4, dtype=dtype)

In [152]: arr
Out[152]: 
array([([0, 0, 0], 0), ([0, 0, 0], 0), ([0, 0, 0], 0), ([0, 0, 0], 0)],
      dtype=[('x', '<i8', (3,)), ('y', '<i4')])
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå„ä¸ªè®°å½•çš„xå­—æ®µæ‰€è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º3çš„æ•°ç»„ï¼š
```python
In [153]: arr[0]['x']
Out[153]: array([0, 0, 0])
```

è¿™æ ·ï¼Œè®¿é—®arr['x']å³å¯å¾—åˆ°ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œè€Œä¸æ˜¯å‰é¢é‚£ä¸ªä¾‹å­ä¸­çš„ä¸€ç»´æ•°ç»„ï¼š
```python
In [154]: arr['x']
Out[154]: 
array([[0, 0, 0],
       [0, 0, 0],
       [0, 0, 0],
       [0, 0, 0]])
```

è¿™å°±ä½¿ä½ èƒ½ç”¨å•ä¸ªæ•°ç»„çš„å†…å­˜å—å­˜æ”¾å¤æ‚çš„åµŒå¥—ç»“æ„ã€‚ä½ è¿˜å¯ä»¥åµŒå¥—dtypeï¼Œä½œå‡ºæ›´å¤æ‚çš„ç»“æ„ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š
```python
In [155]: dtype = [('x', [('a', 'f8'), ('b', 'f4')]), ('y', np.int32)]

In [156]: data = np.array([((1, 2), 5), ((3, 4), 6)], dtype=dtype)

In [157]: data['x']
Out[157]: 
array([( 1.,  2.), ( 3.,  4.)],
      dtype=[('a', '<f8'), ('b', '<f4')])

In [158]: data['y']
Out[158]: array([5, 6], dtype=int32)

In [159]: data['x']['a']
Out[159]: array([ 1.,  3.])
```

pandasçš„DataFrameå¹¶ä¸ç›´æ¥æ”¯æŒè¯¥åŠŸèƒ½ï¼Œä½†å®ƒçš„åˆ†å±‚ç´¢å¼•æœºåˆ¶è·Ÿè¿™ä¸ªå·®ä¸å¤šã€‚

## ä¸ºä»€ä¹ˆè¦ç”¨ç»“æ„åŒ–æ•°ç»„

è·Ÿpandasçš„DataFrameç›¸æ¯”ï¼ŒNumPyçš„ç»“æ„åŒ–æ•°ç»„æ˜¯ä¸€ç§ç›¸å¯¹è¾ƒä½çº§çš„å·¥å…·ã€‚å®ƒå¯ä»¥å°†å•ä¸ªå†…å­˜å—è§£é‡Šä¸ºå¸¦æœ‰ä»»æ„å¤æ‚åµŒå¥—åˆ—çš„è¡¨æ ¼å‹ç»“æ„ã€‚ç”±äºæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åœ¨å†…å­˜ä¸­éƒ½è¢«è¡¨ç¤ºä¸ºå›ºå®šçš„å­—èŠ‚æ•°ï¼Œæ‰€ä»¥ç»“æ„åŒ–æ•°ç»„èƒ½å¤Ÿæä¾›éå¸¸å¿«é€Ÿé«˜æ•ˆçš„ç£ç›˜æ•°æ®è¯»å†™ï¼ˆåŒ…æ‹¬å†…å­˜æ˜ åƒï¼‰ã€ç½‘ç»œä¼ è¾“ç­‰åŠŸèƒ½ã€‚

ç»“æ„åŒ–æ•°ç»„çš„å¦ä¸€ä¸ªå¸¸è§ç”¨æ³•æ˜¯ï¼Œå°†æ•°æ®æ–‡ä»¶å†™æˆå®šé•¿è®°å½•å­—èŠ‚æµï¼Œè¿™æ˜¯Cå’ŒC++ä»£ç ä¸­å¸¸è§çš„æ•°æ®åºåˆ—åŒ–æ‰‹æ®µï¼ˆä¸šç•Œè®¸å¤šå†å²ç³»ç»Ÿä¸­éƒ½èƒ½æ‰¾å¾—åˆ°ï¼‰ã€‚åªè¦çŸ¥é“æ–‡ä»¶çš„æ ¼å¼ï¼ˆè®°å½•çš„å¤§å°ã€å…ƒç´ çš„é¡ºåºã€å­—èŠ‚æ•°ä»¥åŠæ•°æ®ç±»å‹ç­‰ï¼‰ï¼Œå°±å¯ä»¥ç”¨np.fromfileå°†æ•°æ®è¯»å…¥å†…å­˜ã€‚è¿™ç§ç”¨æ³•è¶…å‡ºäº†æœ¬ä¹¦çš„èŒƒå›´ï¼ŒçŸ¥é“è¿™ç‚¹å°±å¯ä»¥äº†ã€‚

# A.6 æ›´å¤šæœ‰å…³æ’åºçš„è¯é¢˜

è·ŸPythonå†…ç½®çš„åˆ—è¡¨ä¸€æ ·ï¼Œndarrayçš„sortå®ä¾‹æ–¹æ³•ä¹Ÿæ˜¯å°±åœ°æ’åºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ•°ç»„å†…å®¹çš„é‡æ–°æ’åˆ—æ˜¯ä¸ä¼šäº§ç”Ÿæ–°æ•°ç»„çš„ï¼š
```python
In [160]: arr = np.random.randn(6)

In [161]: arr.sort()

In [162]: arr
Out[162]: array([-1.082 ,  0.3759,  0.8014,  1.1397,  1.2888,  1.8413])
```

åœ¨å¯¹æ•°ç»„è¿›è¡Œå°±åœ°æ’åºæ—¶è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¦‚æœç›®æ ‡æ•°ç»„åªæ˜¯ä¸€ä¸ªè§†å›¾ï¼Œåˆ™åŸå§‹æ•°ç»„å°†ä¼šè¢«ä¿®æ”¹ï¼š
```python
In [163]: arr = np.random.randn(3, 5)

In [164]: arr
Out[164]: 
array([[-0.3318, -1.4711,  0.8705, -0.0847, -1.1329],
       [-1.0111, -0.3436,  2.1714,  0.1234, -0.0189],
       [ 0.1773,  0.7424,  0.8548,  1.038 , -0.329 ]])

In [165]: arr[:, 0].sort()  # Sort first column values in-place

In [166]: arr
Out[166]: 
array([[-1.0111, -1.4711,  0.8705, -0.0847, -1.1329],
       [-0.3318, -0.3436,  2.1714,  0.1234, -0.0189],
       [ 0.1773,  0.7424,  0.8548,  1.038 , -0.329 ]])
```

ç›¸åï¼Œnumpy.sortä¼šä¸ºåŸæ•°ç»„åˆ›å»ºä¸€ä¸ªå·²æ’åºå‰¯æœ¬ã€‚å¦å¤–ï¼Œå®ƒæ‰€æ¥å—çš„å‚æ•°ï¼ˆæ¯”å¦‚kindï¼‰è·Ÿndarray.sortä¸€æ ·ï¼š
```python
In [167]: arr = np.random.randn(5)

In [168]: arr
Out[168]: array([-1.1181, -0.2415, -2.0051,  0.7379, -1.0614])

In [169]: np.sort(arr)
Out[169]: array([-2.0051, -1.1181, -1.0614, -0.2415,  0.7379])

In [170]: arr
Out[170]: array([-1.1181, -0.2415, -2.0051,  0.7379, -1.0614])
```

è¿™ä¸¤ä¸ªæ’åºæ–¹æ³•éƒ½å¯ä»¥æ¥å—ä¸€ä¸ªaxiså‚æ•°ï¼Œä»¥ä¾¿æ²¿æŒ‡å®šè½´å‘å¯¹å„å—æ•°æ®è¿›è¡Œå•ç‹¬æ’åºï¼š
```python
In [171]: arr = np.random.randn(3, 5)

In [172]: arr
Out[172]: 
array([[ 0.5955, -0.2682,  1.3389, -0.1872,  0.9111],
       [-0.3215,  1.0054, -0.5168,  1.1925, -0.1989],
       [ 0.3969, -1.7638,  0.6071, -0.2222, -0.2171]])

In [173]: arr.sort(axis=1)

In [174]: arr
Out[174]: 
array([[-0.2682, -0.1872,  0.5955,  0.9111,  1.3389],
       [-0.5168, -0.3215, -0.1989,  1.0054,  1.1925],
       [-1.7638, -0.2222, -0.2171,  0.3969,  0.6071]])
```

ä½ å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œè¿™ä¸¤ä¸ªæ’åºæ–¹æ³•éƒ½ä¸å¯ä»¥è¢«è®¾ç½®ä¸ºé™åºã€‚å…¶å®è¿™ä¹Ÿæ— æ‰€è°“ï¼Œå› ä¸ºæ•°ç»„åˆ‡ç‰‡ä¼šäº§ç”Ÿè§†å›¾ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šäº§ç”Ÿå‰¯æœ¬ï¼Œä¹Ÿä¸éœ€è¦ä»»ä½•å…¶ä»–çš„è®¡ç®—å·¥ä½œï¼‰ã€‚è®¸å¤šPythonç”¨æˆ·éƒ½å¾ˆç†Ÿæ‚‰ä¸€ä¸ªæœ‰å…³åˆ—è¡¨çš„å°æŠ€å·§ï¼švalues[::-1]å¯ä»¥è¿”å›ä¸€ä¸ªååºçš„åˆ—è¡¨ã€‚å¯¹ndarrayä¹Ÿæ˜¯å¦‚æ­¤ï¼š
```python
In [175]: arr[:, ::-1]
Out[175]: 
array([[ 1.3389,  0.9111,  0.5955, -0.1872, -0.2682],
       [ 1.1925,  1.0054, -0.1989, -0.3215, -0.5168],
       [ 0.6071,  0.3969, -0.2171, -0.2222, -1.7638]])
```

## é—´æ¥æ’åºï¼šargsortå’Œlexsort

åœ¨æ•°æ®åˆ†æå·¥ä½œä¸­ï¼Œå¸¸å¸¸éœ€è¦æ ¹æ®ä¸€ä¸ªæˆ–å¤šä¸ªé”®å¯¹æ•°æ®é›†è¿›è¡Œæ’åºã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæœ‰å…³å­¦ç”Ÿä¿¡æ¯çš„æ•°æ®è¡¨å¯èƒ½éœ€è¦ä»¥å§“å’Œåè¿›è¡Œæ’åºï¼ˆå…ˆå§“ååï¼‰ã€‚è¿™å°±æ˜¯é—´æ¥æ’åºçš„ä¸€ä¸ªä¾‹å­ï¼Œå¦‚æœä½ é˜…è¯»è¿‡æœ‰å…³pandasçš„ç« èŠ‚ï¼Œé‚£å°±å·²ç»è§è¿‡ä¸å°‘é«˜çº§ä¾‹å­äº†ã€‚ç»™å®šä¸€ä¸ªæˆ–å¤šä¸ªé”®ï¼Œä½ å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªç”±æ•´æ•°ç»„æˆçš„ç´¢å¼•æ•°ç»„ï¼ˆæˆ‘äº²åˆ‡åœ°ç§°ä¹‹ä¸ºç´¢å¼•å™¨ï¼‰ï¼Œå…¶ä¸­çš„ç´¢å¼•å€¼è¯´æ˜äº†æ•°æ®åœ¨æ–°é¡ºåºä¸‹çš„ä½ç½®ã€‚argsortå’Œnumpy.lexsortå°±æ˜¯å®ç°è¯¥åŠŸèƒ½çš„ä¸¤ä¸ªä¸»è¦æ–¹æ³•ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š
```python
In [176]: values = np.array([5, 0, 1, 3, 2])

In [177]: indexer = values.argsort()

In [178]: indexer
Out[178]: array([1, 2, 4, 3, 0])

In [179]: values[indexer]
Out[179]: array([0, 1, 2, 3, 5])
```

ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­ï¼Œä¸‹é¢è¿™æ®µä»£ç æ ¹æ®æ•°ç»„çš„ç¬¬ä¸€è¡Œå¯¹å…¶è¿›è¡Œæ’åºï¼š
```python
In [180]: arr = np.random.randn(3, 5)

In [181]: arr[0] = values

In [182]: arr
Out[182]: 
array([[ 5.    ,  0.    ,  1.    ,  3.    ,  2.    ],
       [-0.3636, -0.1378,  2.1777, -0.4728,  0.8356],
       [-0.2089,  0.2316,  0.728 , -1.3918,  1.9956]])

In [183]: arr[:, arr[0].argsort()]
Out[183]: 
array([[ 0.    ,  1.    ,  2.    ,  3.    ,  5.    ],
       [-0.1378,  2.1777,  0.8356, -0.4728, -0.3636],
       [ 0.2316,  0.728 ,  1.9956, -1.3918, -0.2089]])
```

lexsortè·Ÿargsortå·®ä¸å¤šï¼Œåªä¸è¿‡å®ƒå¯ä»¥ä¸€æ¬¡æ€§å¯¹å¤šä¸ªé”®æ•°ç»„æ‰§è¡Œé—´æ¥æ’åºï¼ˆå­—å…¸åºï¼‰ã€‚å‡è®¾æˆ‘ä»¬æƒ³å¯¹ä¸€äº›ä»¥å§“å’Œåæ ‡è¯†çš„æ•°æ®è¿›è¡Œæ’åºï¼š
```python
In [184]: first_name = np.array(['Bob', 'Jane', 'Steve', 'Bill', 'Barbara'])

In [185]: last_name = np.array(['Jones', 'Arnold', 'Arnold', 'Jones', 'Walters'])

In [186]: sorter = np.lexsort((first_name, last_name))

In [187]: sorter
Out[187]: array([1, 2, 3, 0, 4])

In [188]: zip(last_name[sorter], first_name[sorter])
Out[188]: <zip at 0x7fa203eda1c8>
```

åˆšå¼€å§‹ä½¿ç”¨lexsortçš„æ—¶å€™å¯èƒ½ä¼šæ¯”è¾ƒå®¹æ˜“å¤´æ™•ï¼Œè¿™æ˜¯å› ä¸ºé”®çš„åº”ç”¨é¡ºåºæ˜¯ä»æœ€åä¸€ä¸ªä¼ å…¥çš„ç®—èµ·çš„ã€‚ä¸éš¾çœ‹å‡ºï¼Œlast_nameæ˜¯å…ˆäºfirst_nameè¢«åº”ç”¨çš„ã€‚

>ç¬”è®°ï¼šSerieså’ŒDataFrameçš„sort_indexä»¥åŠSeriesçš„orderæ–¹æ³•å°±æ˜¯é€šè¿‡è¿™äº›å‡½æ•°çš„å˜ä½“ï¼ˆå®ƒä»¬è¿˜å¿…é¡»è€ƒè™‘ç¼ºå¤±å€¼ï¼‰å®ç°çš„ã€‚

## å…¶ä»–æ’åºç®—æ³•

ç¨³å®šçš„ï¼ˆstableï¼‰æ’åºç®—æ³•ä¼šä¿æŒç­‰ä»·å…ƒç´ çš„ç›¸å¯¹ä½ç½®ã€‚å¯¹äºç›¸å¯¹ä½ç½®å…·æœ‰å®é™…æ„ä¹‰çš„é‚£äº›é—´æ¥æ’åºè€Œè¨€ï¼Œè¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼š
```python
In [189]: values = np.array(['2:first', '2:second', '1:first', '1:second',
.....:                    '1:third'])

In [190]: key = np.array([2, 2, 1, 1, 1])

In [191]: indexer = key.argsort(kind='mergesort')

In [192]: indexer
Out[192]: array([2, 3, 4, 0, 1])

In [193]: values.take(indexer)
Out[193]: 
array(['1:first', '1:second', '1:third', '2:first', '2:second'],
      dtype='<U8')
```

mergesortï¼ˆåˆå¹¶æ’åºï¼‰æ˜¯å”¯ä¸€çš„ç¨³å®šæ’åºï¼Œå®ƒä¿è¯æœ‰O(n log n)çš„æ€§èƒ½ï¼ˆç©ºé—´å¤æ‚åº¦ï¼‰ï¼Œä½†æ˜¯å…¶å¹³å‡æ€§èƒ½æ¯”é»˜è®¤çš„quicksortï¼ˆå¿«é€Ÿæ’åºï¼‰è¦å·®ã€‚è¡¨A-3åˆ—å‡ºäº†å¯ç”¨çš„æ’åºç®—æ³•åŠå…¶ç›¸å…³çš„æ€§èƒ½æŒ‡æ ‡ã€‚å¤§éƒ¨åˆ†ç”¨æˆ·å®Œå…¨ä¸éœ€è¦çŸ¥é“è¿™äº›ä¸œè¥¿ï¼Œä½†äº†è§£ä¸€ä¸‹æ€»æ˜¯å¥½çš„ã€‚

![è¡¨A-3 æ•°ç»„æ’åºç®—æ³•](http://upload-images.jianshu.io/upload_images/7178691-970f54f58b6b3356.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## éƒ¨åˆ†æ’åºæ•°ç»„

æ’åºçš„ç›®çš„ä¹‹ä¸€å¯èƒ½æ˜¯ç¡®å®šæ•°ç»„ä¸­æœ€å¤§æˆ–æœ€å°çš„å…ƒç´ ã€‚NumPyæœ‰ä¸¤ä¸ªä¼˜åŒ–æ–¹æ³•ï¼Œnumpy.partitionå’Œnp.argpartitionï¼Œå¯ä»¥åœ¨ç¬¬kä¸ªæœ€å°å…ƒç´ åˆ’åˆ†çš„æ•°ç»„ï¼š
```python
In [194]: np.random.seed(12345)

In [195]: arr = np.random.randn(20)

In [196]: arr
Out[196]: 
array([-0.2047,  0.4789, -0.5194, -0.5557,  1.9658,  1.3934,  0.0929,
        0.2817,  0.769 ,  1.2464,  1.0072, -1.2962,  0.275 ,  0.2289,
        1.3529,  0.8864, -2.0016, -0.3718,  1.669 , -0.4386])

In [197]: np.partition(arr, 3)
Out[197]: 
array([-2.0016, -1.2962, -0.5557, -0.5194, -0.3718, -0.4386, -0.2047,
        0.2817,  0.769 ,  0.4789,  1.0072,  0.0929,  0.275 ,  0.2289,
        1.3529,  0.8864,  1.3934,  1.9658,  1.669 ,  1.2464])
```

å½“ä½ è°ƒç”¨partition(arr, 3)ï¼Œç»“æœä¸­çš„å¤´ä¸‰ä¸ªå…ƒç´ æ˜¯æœ€å°çš„ä¸‰ä¸ªï¼Œæ²¡æœ‰ç‰¹å®šçš„é¡ºåºã€‚numpy.argpartitionä¸numpy.argsortç›¸ä¼¼ï¼Œä¼šè¿”å›ç´¢å¼•ï¼Œé‡æ’æ•°æ®ä¸ºç­‰ä»·çš„é¡ºåºï¼š
```python
In [198]: indices = np.argpartition(arr, 3)

In [199]: indices
Out[199]: 
array([16, 11,  3,  2, 17, 19,  0,  7,  8,  1, 10,  6, 12, 13, 14, 15,  5,
        4, 18,  9])

In [200]: arr.take(indices)
Out[200]: 
array([-2.0016, -1.2962, -0.5557, -0.5194, -0.3718, -0.4386, -0.2047,
        0.2817,  0.769 ,  0.4789,  1.0072,  0.0929,  0.275 ,  0.2289,
        1.3529,  0.8864,  1.3934,  1.9658,  1.669 ,  1.2464])
```

## numpy.searchsortedï¼šåœ¨æœ‰åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ 

searchsortedæ˜¯ä¸€ä¸ªåœ¨æœ‰åºæ•°ç»„ä¸Šæ‰§è¡ŒäºŒåˆ†æŸ¥æ‰¾çš„æ•°ç»„æ–¹æ³•ï¼Œåªè¦å°†å€¼æ’å…¥åˆ°å®ƒè¿”å›çš„é‚£ä¸ªä½ç½®å°±èƒ½ç»´æŒæ•°ç»„çš„æœ‰åºæ€§ï¼š
```python
In [201]: arr = np.array([0, 1, 7, 12, 15])

In [202]: arr.searchsorted(9)
Out[202]: 3
```

ä½ å¯ä»¥ä¼ å…¥ä¸€ç»„å€¼å°±èƒ½å¾—åˆ°ä¸€ç»„ç´¢å¼•ï¼š
```python
In [203]: arr.searchsorted([0, 8, 11, 16])
Out[203]: array([0, 3, 3, 5])
```

ä»ä¸Šé¢çš„ç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºå…ƒç´ 0ï¼Œsearchsortedä¼šè¿”å›0ã€‚è¿™æ˜¯å› ä¸ºå…¶é»˜è®¤è¡Œä¸ºæ˜¯è¿”å›ç›¸ç­‰å€¼ç»„çš„å·¦ä¾§ç´¢å¼•ï¼š
```python
In [204]: arr = np.array([0, 0, 0, 1, 1, 1, 1])

In [205]: arr.searchsorted([0, 1])
Out[205]: array([0, 3])

In [206]: arr.searchsorted([0, 1], side='right')
Out[206]: array([3, 7])
```

å†æ¥çœ‹searchsortedçš„å¦ä¸€ä¸ªç”¨æ³•ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°æ®æ•°ç»„ï¼ˆå…¶ä¸­çš„å€¼åœ¨0åˆ°10000ä¹‹é—´ï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªè¡¨ç¤ºâ€œé¢å…ƒè¾¹ç•Œâ€çš„æ•°ç»„ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨å®ƒå°†æ•°æ®æ•°ç»„æ‹†åˆ†å¼€ï¼š
```python
In [207]: data = np.floor(np.random.uniform(0, 10000, size=50))

In [208]: bins = np.array([0, 100, 1000, 5000, 10000])

In [209]: data
Out[209]: 
array([ 9940.,  6768.,  7908.,  1709.,   268.,  8003., 9037.,   246.,
        4917.,  5262.,  5963.,   519.,  8950.,  7282.,  8183.,  5002.,
        8101.,   959.,  2189.,  2587.,  4681.,  4593.,  7095.,  1780.,
        5314.,  1677.,  7688.,  9281.,  6094.,  1501.,  4896.,  3773.,
        8486.,  9110.,  3838.,  3154.,  5683.,  1878.,  1258.,  6875.,
        7996.,  5735.,  9732.,  6340.,  8884.,  4954.,  3516.,  7142.,
        5039.,  2256.])
```

ç„¶åï¼Œä¸ºäº†å¾—åˆ°å„æ•°æ®ç‚¹æ‰€å±åŒºé—´çš„ç¼–å·ï¼ˆå…¶ä¸­1è¡¨ç¤ºé¢å…ƒ[0,100)ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨searchsortedï¼š
```python
In [210]: labels = bins.searchsorted(data)

In [211]: labels
Out[211]: 
array([4, 4, 4, 3, 2, 4, 4, 2, 3, 4, 4, 2, 4, 4, 4, 4, 4, 2, 3, 3, 3, 3, 4,
       3, 4, 3, 4, 4, 4, 3, 3, 3, 4, 4, 3, 3, 4, 3, 3, 4, 4, 4, 4, 4, 4, 3,
       3, 4, 4, 3])
```

é€šè¿‡pandasçš„groupbyä½¿ç”¨è¯¥ç»“æœå³å¯éå¸¸è½»æ¾åœ°å¯¹åŸæ•°æ®é›†è¿›è¡Œæ‹†åˆ†ï¼š
```python
In [212]: pd.Series(data).groupby(labels).mean()
Out[212]: 
2     498.000000
3    3064.277778
4    7389.035714
dtype: float64
```

#A.7 ç”¨Numbaç¼–å†™å¿«é€ŸNumPyå‡½æ•°

Numbaæ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå®ƒå¯ä»¥åˆ©ç”¨CPUsã€GPUsæˆ–å…¶å®ƒç¡¬ä»¶ä¸ºç±»ä¼¼NumPyçš„æ•°æ®åˆ›å»ºå¿«é€Ÿå‡½æ•°ã€‚å®ƒä½¿ç”¨äº†LLVMé¡¹ç›®ï¼ˆhttp://llvm.org/ï¼‰ï¼Œå°†Pythonä»£ç è½¬æ¢ä¸ºæœºå™¨ä»£ç ã€‚

ä¸ºäº†ä»‹ç»Numbaï¼Œæ¥è€ƒè™‘ä¸€ä¸ªçº¯ç²¹çš„Pythonå‡½æ•°ï¼Œå®ƒä½¿ç”¨forå¾ªç¯è®¡ç®—è¡¨è¾¾å¼(x - y).mean()ï¼š
```python
import numpy as np

def mean_distance(x, y):
    nx = len(x)
    result = 0.0
    count = 0
    for i in range(nx):
        result += x[i] - y[i]
        count += 1
    return result / count
```

è¿™ä¸ªå‡½æ•°å¾ˆæ…¢ï¼š
```python
In [209]: x = np.random.randn(10000000)

In [210]: y = np.random.randn(10000000)

In [211]: %timeit mean_distance(x, y)
1 loop, best of 3: 2 s per loop

In [212]: %timeit (x - y).mean()
100 loops, best of 3: 14.7 ms per loop
```

NumPyçš„ç‰ˆæœ¬è¦æ¯”å®ƒå¿«è¿‡100å€ã€‚æˆ‘ä»¬å¯ä»¥è½¬æ¢è¿™ä¸ªå‡½æ•°ä¸ºç¼–è¯‘çš„Numbaå‡½æ•°ï¼Œä½¿ç”¨numba.jitå‡½æ•°ï¼š
```python
In [213]: import numba as nb

In [214]: numba_mean_distance = nb.jit(mean_distance)
```

ä¹Ÿå¯ä»¥å†™æˆè£…é¥°å™¨ï¼š
```python
@nb.jit
def mean_distance(x, y):
    nx = len(x)
    result = 0.0
    count = 0
    for i in range(nx):
        result += x[i] - y[i]
        count += 1
    return result / count
```

å®ƒè¦æ¯”çŸ¢é‡åŒ–çš„NumPyå¿«ï¼š
```python
In [215]: %timeit numba_mean_distance(x, y)
100 loops, best of 3: 10.3 ms per loop
```

Numbaä¸èƒ½ç¼–è¯‘Pythonä»£ç ï¼Œä½†å®ƒæ”¯æŒçº¯Pythonå†™çš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œå¯ä»¥ç¼–å†™æ•°å€¼ç®—æ³•ã€‚

Numbaæ˜¯ä¸€ä¸ªæ·±åšçš„åº“ï¼Œæ”¯æŒå¤šç§ç¡¬ä»¶ã€ç¼–è¯‘æ¨¡å¼å’Œç”¨æˆ·æ’ä»¶ã€‚å®ƒè¿˜å¯ä»¥ç¼–è¯‘NumPy Python APIçš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸ç”¨forå¾ªç¯ã€‚Numbaä¹Ÿå¯ä»¥è¯†åˆ«å¯ä»¥ä¾¿ä»¥ä¸ºæœºå™¨ç¼–ç çš„ç»“æ„ä½“ï¼Œä½†æ˜¯è‹¥è°ƒç”¨CPython APIï¼Œå®ƒå°±ä¸çŸ¥é“å¦‚ä½•ç¼–è¯‘ã€‚Numbaçš„jitå‡½æ•°æœ‰ä¸€ä¸ªé€‰é¡¹ï¼Œnopython=Trueï¼Œå®ƒé™åˆ¶äº†å¯ä»¥è¢«è½¬æ¢ä¸ºPythonä»£ç çš„ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥ç¼–è¯‘ä¸ºLLVMï¼Œä½†æ²¡æœ‰ä»»ä½•Python C APIè°ƒç”¨ã€‚jit(nopython=True)æœ‰ä¸€ä¸ªç®€çŸ­çš„åˆ«ånumba.njitã€‚

å‰é¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¿™æ ·å†™ï¼š
```python
from numba import float64, njit

@njit(float64(float64[:], float64[:]))
def mean_distance(x, y):
    return (x - y).mean()
```

æˆ‘å»ºè®®ä½ å­¦ä¹ Numbaçš„çº¿ä¸Šæ–‡æ¡£ï¼ˆhttp://numba.pydata.org/ï¼‰ã€‚ä¸‹ä¸€èŠ‚ä»‹ç»ä¸€ä¸ªåˆ›å»ºè‡ªå®šä¹‰Numpy ufuncå¯¹è±¡çš„ä¾‹å­ã€‚

## ç”¨Numbaåˆ›å»ºè‡ªå®šä¹‰numpy.ufuncå¯¹è±¡

numba.vectorizeåˆ›å»ºäº†ä¸€ä¸ªç¼–è¯‘çš„NumPy ufuncï¼Œå®ƒä¸å†…ç½®çš„ufuncå¾ˆåƒã€‚è€ƒè™‘ä¸€ä¸ªnumpy.addçš„Pythonä¾‹å­ï¼š
```python
from numba import vectorize

@vectorize
def nb_add(x, y):
    return x + y
```

ç°åœ¨æœ‰ï¼š
```python
In [13]: x = np.arange(10)

In [14]: nb_add(x, x)
Out[14]: array([  0.,   2.,   4.,   6.,   8.,  10.,  12.,  14.,  16.,  18.])

In [15]: nb_add.accumulate(x, 0)
Out[15]: array([  0.,   1.,   3.,   6.,  10.,  15.,  21.,  28.,  36.,  45.])
```


# A.8 é«˜çº§æ•°ç»„è¾“å…¥è¾“å‡º

æˆ‘åœ¨ç¬¬4ç« ä¸­è®²è¿‡ï¼Œnp.saveå’Œnp.loadå¯ç”¨äºè¯»å†™ç£ç›˜ä¸Šä»¥äºŒè¿›åˆ¶æ ¼å¼å­˜å‚¨çš„æ•°ç»„ã€‚å…¶å®è¿˜æœ‰ä¸€äº›å·¥å…·å¯ç”¨äºæ›´ä¸ºå¤æ‚çš„åœºæ™¯ã€‚å°¤å…¶æ˜¯å†…å­˜æ˜ åƒï¼ˆmemory mapï¼‰ï¼Œå®ƒä½¿ä½ èƒ½å¤„ç†åœ¨å†…å­˜ä¸­æ”¾ä¸ä¸‹çš„æ•°æ®é›†ã€‚

## å†…å­˜æ˜ åƒæ–‡ä»¶

å†…å­˜æ˜ åƒæ–‡ä»¶æ˜¯ä¸€ç§å°†ç£ç›˜ä¸Šçš„éå¸¸å¤§çš„äºŒè¿›åˆ¶æ•°æ®æ–‡ä»¶å½“åšå†…å­˜ä¸­çš„æ•°ç»„è¿›è¡Œå¤„ç†çš„æ–¹å¼ã€‚NumPyå®ç°äº†ä¸€ä¸ªç±»ä¼¼äºndarrayçš„memmapå¯¹è±¡ï¼Œå®ƒå…è®¸å°†å¤§æ–‡ä»¶åˆ†æˆå°æ®µè¿›è¡Œè¯»å†™ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ•°ç»„è¯»å…¥å†…å­˜ã€‚å¦å¤–ï¼Œmemmapä¹Ÿæ‹¥æœ‰è·Ÿæ™®é€šæ•°ç»„ä¸€æ ·çš„æ–¹æ³•ï¼Œå› æ­¤ï¼ŒåŸºæœ¬ä¸Šåªè¦æ˜¯èƒ½ç”¨äºndarrayçš„ç®—æ³•å°±ä¹Ÿèƒ½ç”¨äºmemmapã€‚

è¦åˆ›å»ºä¸€ä¸ªå†…å­˜æ˜ åƒï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•°np.memmapå¹¶ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ã€æ•°æ®ç±»å‹ã€å½¢çŠ¶ä»¥åŠæ–‡ä»¶æ¨¡å¼ï¼š
```python
In [214]: mmap = np.memmap('mymmap', dtype='float64', mode='w+',
   .....:                  shape=(10000, 10000))

In [215]: mmap
Out[215]: 
memmap([[ 0.,  0.,  0., ...,  0.,  0.,  0.],
        [ 0.,  0.,  0., ...,  0.,  0.,  0.],
        [ 0.,  0.,  0., ...,  0.,  0.,  0.],
        ..., 
        [ 0.,  0.,  0., ...,  0.,  0.,  0.],
        [ 0.,  0.,  0., ...,  0.,  0.,  0.],
        [ 0.,  0.,  0., ...,  0.,  0.,  0.]])
```

å¯¹memmapåˆ‡ç‰‡å°†ä¼šè¿”å›ç£ç›˜ä¸Šçš„æ•°æ®çš„è§†å›¾ï¼š
```python
In [216]: section = mmap[:5]
```

å¦‚æœå°†æ•°æ®èµ‹å€¼ç»™è¿™äº›è§†å›¾ï¼šæ•°æ®ä¼šå…ˆè¢«ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼ˆå°±åƒæ˜¯Pythonçš„æ–‡ä»¶å¯¹è±¡ï¼‰ï¼Œè°ƒç”¨flushå³å¯å°†å…¶å†™å…¥ç£ç›˜ï¼š
```python
In [217]: section[:] = np.random.randn(5, 10000)

In [218]: mmap.flush()

In [219]: mmap
Out[219]: 
memmap([[ 0.7584, -0.6605,  0.8626, ...,  0.6046, -0.6212,  2.0542],
        [-1.2113, -1.0375,  0.7093, ..., -1.4117, -0.1719, -0.8957],
        [-0.1419, -0.3375,  0.4329, ...,  1.2914, -0.752 , -0.44  ],
        ..., 
        [ 0.    ,  0.    ,  0.    , ...,  0.    ,  0.    ,  0.    ],
        [ 0.    ,  0.    ,  0.    , ...,  0.    ,  0.    ,  0.    ],
        [ 0.    ,  0.    ,  0.    , ...,  0.    ,  0.    ,  0.    ]])

In [220]: del mmap
```

åªè¦æŸä¸ªå†…å­˜æ˜ åƒè¶…å‡ºäº†ä½œç”¨åŸŸï¼Œå®ƒå°±ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œä¹‹å‰å¯¹å…¶æ‰€åšçš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šè¢«å†™å…¥ç£ç›˜ã€‚å½“æ‰“å¼€ä¸€ä¸ªå·²ç»å­˜åœ¨çš„å†…å­˜æ˜ åƒæ—¶ï¼Œä»ç„¶éœ€è¦æŒ‡æ˜æ•°æ®ç±»å‹å’Œå½¢çŠ¶ï¼Œå› ä¸ºç£ç›˜ä¸Šçš„é‚£ä¸ªæ–‡ä»¶åªæ˜¯ä¸€å—äºŒè¿›åˆ¶æ•°æ®è€Œå·²ï¼Œæ²¡æœ‰ä»»ä½•å…ƒæ•°æ®ï¼š
```python
In [221]: mmap = np.memmap('mymmap', dtype='float64', shape=(10000, 10000))

In [222]: mmap
Out[222]: 
memmap([[ 0.7584, -0.6605,  0.8626, ...,  0.6046, -0.6212,  2.0542],
        [-1.2113, -1.0375,  0.7093, ..., -1.4117, -0.1719, -0.8957],
        [-0.1419, -0.3375,  0.4329, ...,  1.2914, -0.752 , -0.44  ],
        ..., 
        [ 0.    ,  0.    ,  0.    , ...,  0.    ,  0.    ,  0.    ],
        [ 0.    ,  0.    ,  0.    , ...,  0.    ,  0.    ,  0.    ],
        [ 0.    ,  0.    ,  0.    , ...,  0.    ,  0.    ,  0.    ]])
```

å†…å­˜æ˜ åƒå¯ä»¥ä½¿ç”¨å‰é¢ä»‹ç»çš„ç»“æ„åŒ–æˆ–åµŒå¥—dtypeã€‚

## HDF5åŠå…¶ä»–æ•°ç»„å­˜å‚¨æ–¹å¼

PyTableså’Œh5pyè¿™ä¸¤ä¸ªPythoné¡¹ç›®å¯ä»¥å°†NumPyçš„æ•°ç»„æ•°æ®å­˜å‚¨ä¸ºé«˜æ•ˆä¸”å¯å‹ç¼©çš„HDF5æ ¼å¼ï¼ˆHDFæ„æ€æ˜¯â€œå±‚æ¬¡åŒ–æ•°æ®æ ¼å¼â€ï¼‰ã€‚ä½ å¯ä»¥å®‰å…¨åœ°å°†å¥½å‡ ç™¾GBç”šè‡³TBçš„æ•°æ®å­˜å‚¨ä¸ºHDF5æ ¼å¼ã€‚è¦å­¦ä¹ Pythonä½¿ç”¨HDF5ï¼Œè¯·å‚è€ƒpandasçº¿ä¸Šæ–‡æ¡£ã€‚

# A.9 æ€§èƒ½å»ºè®®

ä½¿ç”¨NumPyçš„ä»£ç çš„æ€§èƒ½ä¸€èˆ¬éƒ½å¾ˆä¸é”™ï¼Œå› ä¸ºæ•°ç»„è¿ç®—ä¸€èˆ¬éƒ½æ¯”çº¯Pythonå¾ªç¯å¿«å¾—å¤šã€‚ä¸‹é¢å¤§è‡´åˆ—å‡ºäº†ä¸€äº›éœ€è¦æ³¨æ„çš„äº‹é¡¹ï¼š

- å°†Pythonå¾ªç¯å’Œæ¡ä»¶é€»è¾‘è½¬æ¢ä¸ºæ•°ç»„è¿ç®—å’Œå¸ƒå°”æ•°ç»„è¿ç®—ã€‚
- å°½é‡ä½¿ç”¨å¹¿æ’­ã€‚
- é¿å…å¤åˆ¶æ•°æ®ï¼Œå°½é‡ä½¿ç”¨æ•°ç»„è§†å›¾ï¼ˆå³åˆ‡ç‰‡ï¼‰ã€‚
- åˆ©ç”¨ufuncåŠå…¶å„ç§æ–¹æ³•ã€‚

å¦‚æœå•ç”¨NumPyæ— è®ºå¦‚ä½•éƒ½è¾¾ä¸åˆ°æ‰€éœ€çš„æ€§èƒ½æŒ‡æ ‡ï¼Œå°±å¯ä»¥è€ƒè™‘ä¸€ä¸‹ç”¨Cã€Fortranæˆ–Cythonï¼ˆç­‰ä¸‹ä¼šç¨å¾®ä»‹ç»ä¸€ä¸‹ï¼‰æ¥ç¼–å†™ä»£ç ã€‚æˆ‘è‡ªå·±åœ¨å·¥ä½œä¸­ç»å¸¸ä¼šç”¨åˆ°Cythonï¼ˆhttp://cython.orgï¼‰ï¼Œå› ä¸ºå®ƒä¸ç”¨èŠ±è´¹æˆ‘å¤ªå¤šç²¾åŠ›å°±èƒ½å¾—åˆ°Cè¯­è¨€é‚£æ ·çš„æ€§èƒ½ã€‚

## è¿ç»­å†…å­˜çš„é‡è¦æ€§

è™½ç„¶è¿™ä¸ªè¯é¢˜æœ‰ç‚¹è¶…å‡ºæœ¬ä¹¦çš„èŒƒå›´ï¼Œä½†è¿˜æ˜¯è¦æä¸€ä¸‹ï¼Œå› ä¸ºåœ¨æŸäº›åº”ç”¨åœºæ™¯ä¸­ï¼Œæ•°ç»„çš„å†…å­˜å¸ƒå±€å¯ä»¥å¯¹è®¡ç®—é€Ÿåº¦é€ æˆæå¤§çš„å½±å“ã€‚è¿™æ˜¯å› ä¸ºæ€§èƒ½å·®åˆ«åœ¨ä¸€å®šç¨‹åº¦ä¸Šè·ŸCPUçš„é«˜é€Ÿç¼“å­˜ï¼ˆcacheï¼‰ä½“ç³»æœ‰å…³ã€‚è¿ç®—è¿‡ç¨‹ä¸­è®¿é—®è¿ç»­å†…å­˜å—ï¼ˆä¾‹å¦‚ï¼Œå¯¹ä»¥Cé¡ºåºå­˜å‚¨çš„æ•°ç»„çš„è¡Œæ±‚å’Œï¼‰ä¸€èˆ¬æ˜¯æœ€å¿«çš„ï¼Œå› ä¸ºå†…å­˜å­ç³»ç»Ÿä¼šå°†é€‚å½“çš„å†…å­˜å—ç¼“å­˜åˆ°è¶…é«˜é€Ÿçš„L1æˆ–L2CPU Cacheä¸­ã€‚æ­¤å¤–ï¼ŒNumPyçš„Cè¯­è¨€åŸºç¡€ä»£ç ï¼ˆæŸäº›ï¼‰å¯¹è¿ç»­å­˜å‚¨çš„æƒ…å†µè¿›è¡Œäº†ä¼˜åŒ–å¤„ç†ï¼Œè¿™æ ·å°±èƒ½é¿å…ä¸€äº›è·¨è¶Šå¼çš„å†…å­˜è®¿é—®ã€‚

ä¸€ä¸ªæ•°ç»„çš„å†…å­˜å¸ƒå±€æ˜¯è¿ç»­çš„ï¼Œå°±æ˜¯è¯´å…ƒç´ æ˜¯ä»¥å®ƒä»¬åœ¨æ•°ç»„ä¸­å‡ºç°çš„é¡ºåºï¼ˆå³Fortranå‹ï¼ˆåˆ—ä¼˜å…ˆï¼‰æˆ–Cå‹ï¼ˆè¡Œä¼˜å…ˆï¼‰ï¼‰å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒNumPyæ•°ç»„æ˜¯ä»¥Cå‹è¿ç»­çš„æ–¹å¼åˆ›å»ºçš„ã€‚åˆ—ä¼˜å…ˆçš„æ•°ç»„ï¼ˆæ¯”å¦‚Cå‹è¿ç»­æ•°ç»„çš„è½¬ç½®ï¼‰ä¹Ÿè¢«ç§°ä¸ºFortranå‹è¿ç»­ã€‚é€šè¿‡ndarrayçš„flagså±æ€§å³å¯æŸ¥çœ‹è¿™äº›ä¿¡æ¯ï¼š
```python
In [225]: arr_c = np.ones((1000, 1000), order='C')

In [226]: arr_f = np.ones((1000, 1000), order='F')

In [227]: arr_c.flags

Out[227]: 
  C_CONTIGUOUS : True
  F_CONTIGUOUS : False
  OWNDATA : True
  WRITEABLE : True
  ALIGNED : True
  UPDATEIFCOPY : False

In [228]: arr_f.flags
Out[228]: 
  C_CONTIGUOUS : False
  F_CONTIGUOUS : True
  OWNDATA : True
  WRITEABLE : True
  ALIGNED : True
  UPDATEIFCOPY : False

In [229]: arr_f.flags.f_contiguous
Out[229]: True
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯¹ä¸¤ä¸ªæ•°ç»„çš„è¡Œè¿›è¡Œæ±‚å’Œè®¡ç®—ï¼Œç†è®ºä¸Šè¯´ï¼Œarr_cä¼šæ¯”arr_få¿«ï¼Œå› ä¸ºarr_cçš„è¡Œåœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨IPythonä¸­ç”¨%timeitæ¥ç¡®è®¤ä¸€ä¸‹ï¼š
```python
In [230]: %timeit arr_c.sum(1)
784 us +- 10.4 us per loop (mean +- std. dev. of 7 runs, 1000 loops each)

In [231]: %timeit arr_f.sum(1)
934 us +- 29 us per loop (mean +- std. dev. of 7 runs, 1000 loops each)
```

å¦‚æœæƒ³ä»NumPyä¸­æå‡æ€§èƒ½ï¼Œè¿™é‡Œå°±åº”è¯¥æ˜¯ä¸‹æ‰‹çš„åœ°æ–¹ã€‚å¦‚æœæ•°ç»„çš„å†…å­˜é¡ºåºä¸ç¬¦åˆä½ çš„è¦æ±‚ï¼Œä½¿ç”¨copyå¹¶ä¼ å…¥'C'æˆ–'F'å³å¯è§£å†³è¯¥é—®é¢˜ï¼š
```python
In [232]: arr_f.copy('C').flags
Out[232]: 
  C_CONTIGUOUS : True
  F_CONTIGUOUS : False
  OWNDATA : True
  WRITEABLE : True
  ALIGNED : True
  UPDATEIFCOPY : False
```

æ³¨æ„ï¼Œåœ¨æ„é€ æ•°ç»„çš„è§†å›¾æ—¶ï¼Œå…¶ç»“æœä¸ä¸€å®šæ˜¯è¿ç»­çš„ï¼š
```python
In [233]: arr_c[:50].flags.contiguous
Out[233]: True

In [234]: arr_c[:, :50].flags
Out[234]: 
  C_CONTIGUOUS : False
  F_CONTIGUOUS : False
  OWNDATA : False
  WRITEABLE : True
  ALIGNED : True
  UPDATEIFCOPY : False
```
